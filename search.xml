<?xml version="1.0" encoding="utf-8"?>
<search>
  
    
    <entry>
      <title><![CDATA[spring AOP åŸºç¡€]]></title>
      <url>%2F2017%2F02%2F08%2Fspring-aop-1%2F</url>
      <content type="text"><![CDATA[åˆ‡é¢ç¼–ç¨‹é¢å‘åˆ‡é¢ç¼–ç¨‹ AOP(Aspect-Oriented Programming) æ˜¯ä»Žä¸€ä¸ªä¸åŒçš„ç¼–ç¨‹æ–¹å¼è§’åº¦å¯¹ é¢å‘å¯¹è±¡ç¼–ç¨‹ OOP çš„å®Œå–„ã€‚åœ¨åˆ‡é¢ç¼–ç¨‹ä¸­ï¼Œåˆ‡é¢æ˜¯ä¸€ä¸ªå…³é”®å…ƒç´ ï¼Œæ­£å¦‚é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­å¯¹è±¡æ˜¯ä¸€ä¸ªæ ¸å¿ƒå…ƒç´ ã€‚åˆ‡é¢çš„åŠŸèƒ½æ˜¯ä½¿ä¸€äº›è·¨è¶Šå¯¹è±¡çš„é€»è¾‘æ¨¡å—åŒ–ï¼Œå¦‚ äº‹åŠ¡ç®¡ç†ã€‚ ä¸€. åŸºæœ¬æ¦‚å¿µè®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹spring AOP çš„ä¸€äº›åŸºç¡€æ¦‚å¿µ: aspect(åˆ‡é¢): è·¨è¶Šå¤šä¸ªç±»çš„å…±åŒé€»è¾‘ï¼Œå³ä»Žå¤šä¸ªç±»ä¸­æŠ½å‡ºçš„ç›¸åŒæ‰§è¡Œæ¨¡å—ï¼Œå¦‚äº‹åŠ¡ç®¡ç†æ¨¡å—ã€‚æ­¤å¤„ aspcet åªæ˜¯æ¦‚å¿µæ€§å…³é”®å­—ï¼Œ ä¸‹é¢ä»‹ç»çš„å…¶ä»–å…³é”®å­—éƒ½å±žäºŽåˆ‡é¢çš„èŒƒç•´ã€‚ join point(è¿žæŽ¥ç‚¹): ç¨‹åºä¸­å…è®¸åˆ‡é¢æ‰§è¡Œçš„æ—¶æœºï¼Œå¦‚æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œå¼‚å¸¸å¤„ç†æ—¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯springåªæ”¯æŒæ–¹æ³•è¿žæŽ¥ç‚¹ã€‚ advice(é€šçŸ¥): advice æ˜¯åˆ‡é¢åœ¨åˆ‡ç‚¹å¤„çš„æ‰§è¡Œé€»è¾‘ï¼Œå…¶æŒ‰ç…§å…¶æ‰§è¡Œæ–¹å¼å¯ä»¥åˆ†æˆbefore advice, after advice, after throwing advice, after returning advice, around adviceäº”ç§ã€‚ pointcut(åˆ‡ç‚¹): pointcut å®šä¹‰äº†åˆ‡é¢ä¸Žè¿žæŽ¥ç‚¹çš„åŒ¹é…è§„åˆ™ã€‚advice ä¼šæ ¹æ® pointcut å®šä¹‰çš„è§„åˆ™åŽ»åŒ¹é…ç›¸åº”çš„ joint point, å¹¶æœ€ç»ˆæ‰§è¡Œ advice å®šä¹‰çš„åˆ‡é¢é€»è¾‘ã€‚ introduction(å¼•å…¥): è¿™åº”è¯¥å¯ä»¥ç†è§£æˆåˆ‡é¢ç¼–ç¨‹ä¸­ä¸€ä¸ªç‰¹æ®Šçš„åŠŸèƒ½: å‘ä¸€ä¸ªç±»ä¸­å¼•å…¥å¤–éƒ¨æŽ¥å£å’Œå±žæ€§ï¼Œç®€å•åœ°è¯´å°±æ˜¯æ‰©å±•ä¸€ä¸ªç±»å¯¹å¤–æš´éœ²çš„æŽ¥å£ã€‚ target object(ç›®æ ‡å¯¹è±¡): è¢«åˆ‡é¢åˆ‡å…¥ä»£ç†é€»è¾‘çš„ä¸šåŠ¡å¯¹è±¡ã€‚ AOP proxy(åˆ‡é¢ä»£ç†å¯¹è±¡): æ¡†æž¶ä¸ºå®žçŽ°åˆ‡é¢ç”Ÿæˆçš„åŠ¨æ€ä»£ç†å¯¹è±¡ã€‚spring åŠ¨æ€ä»£ç†å¯¹è±¡å¯ä»¥åˆ†ä¸ºJDK dynamic proxy å’Œ CGLIB dynamic proxyã€‚ waving(ç»‡å…¥): æŒ‡å®žçŽ°åˆ‡é¢å’Œç›®æ ‡ç±»è¿›è¡Œå…³è”çš„è¡Œä¸ºè¿‡ç¨‹ï¼Œé€šå¸¸ ç¼–è¯‘,åŠ è½½,è¿è¡Œ çŽ¯èŠ‚éƒ½å¯è¿›è¡Œã€‚spring AOP æ¡†æž¶ å’Œ å…¶ä»– çº¯ java aop æ¡†æž¶ ä¸€æ ·åªåœ¨è¿è¡Œæ—¶è¿›è¡Œç»‡å…¥ã€‚ è¿™äº›æ¦‚å¿µç›®å‰çœ‹æ¥å¯èƒ½è¿˜ä¸å¤§ç›´è§‚ï¼Œä½†æ˜¯ä¸ç”¨ç€æ€¥ï¼Œåœ¨åŽé¢çš„æ ·ä¾‹ä¸­æˆ‘ä»¬å°†é€ä¸€è¯¦ç»†äº†è§£ã€‚åˆ°æ—¶å€™å†å›žé¡¾æ¥çœ‹å°±è‚¯å®šæ¸…æ™°äº†ã€‚ äºŒ. spring AOP ç‰¹ç‚¹è¿™é‡Œè®©æˆ‘ä»¬ç®€å•äº†è§£ä¸€ä¸‹ spring AOP çš„ç‰¹ç‚¹ï¼ˆç›¸è¾ƒå…¶ä»– AOP æ¡†æž¶ï¼Œå¦‚ AspectJ è€Œè¨€ï¼‰: spring AOP æ˜¯ä¸€ä¸ªçº¯javaå®žçŽ°çš„AOPæ¡†æž¶ï¼Œå› æ­¤åªæ”¯æŒè¿è¡Œæ—¶è¿›è¡Œåˆ‡é¢ç»‡å…¥; spring ç›®å‰åªæ”¯æŒ æ–¹æ³•çº§åˆ«çš„åˆ‡ç‚¹(method join point)ï¼ˆfield join point å®žçŽ° å¯ä»¥è€ƒè™‘ä½¿ç”¨ AspectJ æ¡†æž¶ï¼‰; spring AOP å¹¶ä¸ä»¥ä¸€ä¸ª å°½å–„é™ç¾Žçš„AOPå®žçŽ° ä½œä¸ºç›®æ ‡ï¼Œå®ƒå¸Œæœ›æŽ¨å‡ºä¸€ä¸ªèƒ½ä¸Ž spring IOC æ¡†æž¶ æ•´åˆ çš„æ¡†æž¶ï¼Œä½¿å®ƒä»¬ä¸€èµ·ä¸ºä¼ä¸šçº§åº”ç”¨æä¾›ä¾¿æ·çš„å¼€å‘è§£å†³æ–¹æ¡ˆã€‚ spring AOP åŠ¨æ€ä»£ç†æœ‰ä¸¤ç§å®žçŽ°å½¢å¼: JDK åŽŸç”ŸåŠ¨æ€ä»£ç† å’Œ CGLIB åŠ¨æ€ä»£ç†ã€‚å¦‚æžœè¢«ä»£ç†çš„ç›®æ ‡å¯¹è±¡æ²¡æœ‰å®žçŽ°æŽ¥å£ï¼ŒCGLIB åŠ¨æ€ä»£ç† å°†è¢«ç½®ä¸ºé»˜è®¤é€‰æ‹©ã€‚ ä¸‰. spring AOP è¯¦è§£è¿™é‡Œå› ä¸ºç¯‡å¹…åŽŸå› æˆ‘åªæè¿° spring åŸºäºŽæ³¨è§£çš„ AOP å®žçŽ°ï¼Œspring è¿˜æ”¯æŒåŸºäºŽ xml schema é…ç½®çš„ AOP å®žçŽ°ï¼Œå®ƒä»¬é™¤äº†è¡¨çŽ°å½¢å¼ä¸åŒä¹‹å¤–æ²¡ä»€ä¹ˆå…¶ä»–åŒºåˆ«ã€‚ç›¸æ¯”è€Œè¨€ æ³¨è§£å½¢å¼ æ›´æ¸…æ™°ä¾¿æ·ã€‚å¯¹ xml schema é…ç½®å½¢å¼æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªå·±äº†è§£ã€‚ I. ä½¿ç”¨ @AspectJ æ³¨è§£å£°æ˜Žåˆ‡é¢ @AspectJ æ˜¯ Aspectjæ¡†æž¶æ”¯æŒçš„æ³¨è§£ï¼Œé€šè¿‡å¼•å…¥ AspectJ Library ä¾èµ–, spring å°†æ”¯æŒ AspectJ ä¸­ç›¸å…³æ³¨è§£çš„è§£æžï¼Œä½†æ˜¯springä¸ä¼šä½¿ç”¨ AspectJ ä¸­çš„ç¼–è¯‘å’Œç»‡å…¥åŠŸèƒ½ã€‚ å¼•å…¥ AspectJ Library åŽï¼Œ @AspectJ æ³¨è§£å°†å¯ä»¥å£°æ˜Žä¸€ä¸ªæ™®é€šclassä¸ºåˆ‡é¢å®šä¹‰ç±»ã€‚ maven ä¾èµ–å¼•å…¥æ ·ä¾‹å¦‚ä¸‹: 123456789101112 &lt;dependency&gt; &lt;groupId&gt;org.aspectj&lt;/groupId&gt; &lt;artifactId&gt;aspectjrt&lt;/artifactId&gt; &lt;version&gt;1.8.1&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.aspectj&lt;/groupId&gt; &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt; &lt;version&gt;1.8.1&lt;/version&gt;&lt;/dependency&gt; å¯ç”¨åˆ‡é¢æ³¨è§£é…ç½®åŠŸèƒ½: spring åŒæ—¶æ”¯æŒ XML schema åˆ‡é¢é…ç½® å’Œ æ³¨è§£å½¢å¼ åˆ‡é¢é…ç½®ï¼Œè‹¥æƒ³å¯ç”¨æ³¨è§£æ–¹å¼ï¼Œåˆ™éœ€è¦åœ¨é…ç½®ç±»(@Configuration æ³¨é‡Šçš„ç±»)ä¸Šæ ‡æ³¨å¯ç”¨æ ‡ç­¾@EnableAspectJAutoProxy: 1234@Configuration@EnableAspectJAutoProxy//@EnableAspectJAutoProxy(proxyTargetClass = true) // å°†ä»£ç†æ–¹å¼é€‰å®šä¸º CGLIBåŠ¨æ€ä»£ç†public class AppConfig &#123; &#125; æ³¨æ„ @EnableAspectJAutoProxy å¯ä»¥æŒ‡å®š proxyTargetClass å±žæ€§ï¼Œå®ƒç”¨æ¥æŽ§åˆ¶æ˜¯å¦åªç”¨ CGLIB åŠ¨æ€ä»£ç†(é»˜è®¤ä¸ºfalse, å³ç”±springæ¡†æž¶è‡ªåŠ¨é€‰æ‹©ä»£ç†é€»è¾‘)ã€‚ å£°æ˜Žåˆ‡é¢: åªéœ€è¦åœ¨å®šä¹‰çš„åˆ‡é¢ç±»ä¸ŠåŠ ä¸Š @AspectJ æ³¨è§£å³å¯å°†å…¶æ ‡æ³¨ä¸ºåˆ‡é¢å®šä¹‰ç±»: 1234package org.xyz;import org.aspectj.lang.annotation.Aspect;@Aspectpublic class NotVeryUsefulAspect &#123; &#125; æ³¨æ„éœ€è¦ä¿è¯è¯¥ç±»èƒ½å¤Ÿè¢«é…ç½®ç±»æ‰«æåˆ°ã€‚ II. pointcut å£°æ˜Ž pointcut(åˆ‡ç‚¹)ç”¨æ¥å®šä¹‰ advice(åˆ‡é¢é€»è¾‘) å’Œ joint point(è¿žæŽ¥ç‚¹) çš„åŒ¹é…è§„åˆ™ã€‚åœ¨springä¸­ï¼Œç›®å‰æ”¯æŒçš„è¿žæŽ¥ç‚¹ç±»åž‹åªæœ‰æ–¹æ³•ï¼Œå› æ­¤å¯ä»¥è®¤ä¸º pointcut åªç”¨æ¥å®šä¹‰æ–¹æ³•åŒ¹é…è§„åˆ™å°±å¥½äº†ã€‚ ä¸€ä¸ªpointcutå£°æ˜ŽåŒ…å«ä¸¤ä¸ªéƒ¨åˆ†: pointcut æ–¹æ³•å£°æ˜Žï¼Œè¯¥æ–¹æ³•æ²¡æœ‰ä»»ä½•å‚æ•°ï¼Œè¿”å›žå€¼ä¸ºvoid; pointcut è¡¨è¾¾å¼, ä½¿ç”¨ @Pointcut æ³¨è§£å®šä¹‰; å°†pointcutæ ·ä¾‹å¦‚ä¸‹: 12ï¿¼ @Pointcut("execution(* transfer(..))")// the pointcut expression private void anyOldTransfer() &#123;&#125;// the pointcut signature spring çš„ pointcut è¡¨è¾¾å¼å°±æ˜¯å¤ç”¨ AspectJ çš„pointcutè¡¨è¾¾å¼ã€‚ III. spring æ”¯æŒçš„ pointcut è¡¨è¾¾å¼ç±»åž‹ spring åªæ˜¯æ”¯æŒäº†éƒ¨åˆ†çš„ AspectJ pointcut è¡¨è¾¾å¼è§„åˆ™ï¼ŒæŽ¥ä¸‹æ¥æˆ‘ä»¬é€ä¸€è®²è§£å…¶æ‰€æ”¯æŒçš„è¡¨è¾¾å¼è§„åˆ™ã€‚ execution åˆ‡ç‚¹ execution åˆ‡ç‚¹æ˜¯æœ€å¸¸ç”¨çš„åˆ‡ç‚¹å®šä¹‰æ–¹å¼ï¼Œå…¶å®šä¹‰æ¨¡å¼å¦‚ä¸‹: 1execution(modifier-pattern? ret-type-pattern declaring-type-pattern?name-pattern(param-patterm) throw-pattern?) pattern å«ä¹‰ æ˜¯å¦å¿…é¡»å®šä¹‰ modifier-pattern ä¿®é¥°ç¬¦ å¦ ret-type-pattern è¿”å›žå€¼ç±»åž‹å®šä¹‰ æ˜¯ declaring-type-pattern æ–¹æ³•ç±»å®šä¹‰ å¦ name-pattern æ–¹æ³•åç§°å®šä¹‰ æ˜¯ param-patterm å‚æ•°åˆ—è¡¨å®šä¹‰ æ˜¯ throw-pattern å¼‚å¸¸ç±»åž‹å®šä¹‰ å¦ pattern å¯ä»¥ä½¿ç”¨é€šé…ç¬¦å®šä¹‰: * ç”¨æ¥åŒ¹é…æ‰€æœ‰æ¨¡å¼ï¼Œ.ç”¨æ¥è¡¨ç¤ºç±»è·¯å¾„çš„åˆ†é‡ç¬¦,..è¡¨ç¤ºä¸€ä¸ªåŒ…åŠå…¶å­åŒ…ä¸‹çš„ä»»æ„ç±», (..)å¯ä»¥è¡¨ç¤ºä»»æ„å‚æ•°åˆ—è¡¨(è¡¨ç¤ºåŒ…å«é›¶ä¸ªæˆ–å¤šä¸ªä»»æ„ç±»åž‹å‚æ•°) execution pointcut å®šä¹‰æ ·ä¾‹: 12345678910111213141516171819202122232425262728293031323334/** * ä»»æ„publicæ–¹æ³•ä¸ºåˆ‡å…¥ç‚¹ */@Pointcut("execution(public * *(..))")public void anyPublicOperation() &#123;&#125;/** * ä»»æ„setæ–¹æ³•ä¸ºåˆ‡å…¥ç‚¹ */@Pointcut("execution(* set*(..)")public void anySetOperation() &#123;&#125;/** * me.service åŒ…ä¸‹ä»»æ„ç±»çš„æ–¹æ³• */@Pointcut("execution(* me.service.*(..)")public void anyServiceOperation() &#123;&#125;/** * me.service åŒ…åŠå…¶å­åŒ…ä¸‹ä»»æ„ç±»çš„æ–¹æ³• */@Pointcut("execution(* me.service..*(..)")public void anyServiceBaseOperation() &#123;&#125;/** * ä»»æ„å‚æ•°åˆ—è¡¨åŒ…å«ä¸¤ä¸ªå‚æ•°,ä¸”ç¬¬äºŒä¸ªå‚æ•°ç±»åž‹æ˜¯Stringç±»åž‹çš„æ–¹æ³• */@Pointcut("execution(* *(*, String)")public void anyStringParamInSecondPlaceOperation() &#123;&#125; æ ·ä¾‹ä¸­æ³¨é‡Šè¯´æ˜Žè¯¦å°½ï¼Œå¯ä»¥çœ‹å‡º execution ç±»åž‹çš„pointcutåŸºæœ¬å¯ä»¥æ»¡è¶³ä»»æ„åœºæ™¯çš„æ–¹æ³•è§„åˆ™åŒ¹é…ã€‚å…¶ä»–pointcutç±»åž‹å¯ä»¥çœ‹åš execution çš„éƒ¨åˆ†é™å®šè§„åˆ™ã€‚ within åˆ‡ç‚¹ within åˆ‡ç‚¹åªåšäº†åŒ…å’Œç±»åž‹çš„é™å®š: 123456/** * ä»»æ„ me.service åŒ…åŠå…¶å­åŒ…ä¸‹å„ä¸ªç±»åž‹çš„æ–¹æ³• */@Pointcut("within(me.service..*)")public void withinOperation() &#123;&#125; args åˆ‡ç‚¹: args åˆ‡ç‚¹åªåšäº†å‚æ•°åˆ—è¡¨çš„é™å®š: 123456/** * ä»»æ„å‚æ•°åˆ—è¡¨åŒ…å«ä¸¤ä¸ªå‚æ•°,ä¸”ç¬¬äºŒä¸ªå‚æ•°ç±»åž‹æ˜¯Stringç±»åž‹çš„æ–¹æ³• */@Pointcut("args(*, String)")public void argsOperation() &#123;&#125; args åˆ‡ç‚¹å’Œ execution execution(* *(*, String) åˆ‡ç‚¹è¿˜æ˜¯ä¸å¤ªç›¸åŒçš„ï¼Œexecution é™å®šäº†ç›®æ ‡æ–¹æ³•çš„å®šä¹‰æ–¹å¼ï¼Œè€Œargsåˆ™é™å®šäº†ç›®æ ‡æ–¹æ³•åœ¨è¿è¡Œæ—¶æ˜¯å¦ä¼ å…¥ (*, String) å‚æ•°åˆ—è¡¨,æ˜¯ä¸€ç§è¿è¡Œæ—¶é™å®šã€‚ this åˆ‡ç‚¹: this ç”¨æ¥é™å®šä»£ç†å¯¹è±¡(proxy object)æ˜¯å¦å®žçŽ°äº†æŸä¸ªæŽ¥å£: 123456/** * å½“ä¸€ä¸ªä»£ç†å¯¹è±¡å®žçŽ°äº† me.Service æŽ¥å£æ—¶æ‰è¿›è¡Œä»£ç†é€»è¾‘åˆ‡å…¥ */ @Pointcut("this(me.Service)") public void thisOperation() &#123; &#125; target åˆ‡å…¥: target ç”¨æ¥é™å®šç›®æ ‡å¯¹è±¡(target object)æ˜¯å¦å®žçŽ°äº†æŸä¸ªæŽ¥å£: 123456/** * å½“ä¸€ä¸ªç›®æ ‡å¯¹è±¡å®žçŽ°äº† me.Service æŽ¥å£æ—¶æ‰è¿›è¡Œä»£ç†é€»è¾‘åˆ‡å…¥ */ @Pointcut("target(me.Service)") public void targetOperation() &#123; &#125; æ³¨æ„ this åˆ‡å…¥ å’Œ target åˆ‡å…¥ ç±»åž‹çš„åŒºåˆ«ï¼Œthisæ˜¯å¯¹ä»£ç†å¯¹è±¡çš„é™å®šè§„åˆ™ï¼Œtargetæ˜¯å¯¹ç›®æ ‡å¯¹è±¡çš„é™å®šè§„åˆ™ã€‚éœ€è¦äº†è§£çš„æ˜¯ JDK åŠ¨æ€ä»£ç† åœ¨å®žçŽ°æ—¶ï¼Œproxyå¯¹è±¡å®žçŽ°äº†ä»£ç†æŽ¥å£ï¼Œè€Œ CGLIB åŠ¨æ€ä»£ç† å´å¹¶ä¸ä¸€å®šã€‚åŒæ—¶spring AOP çš„ Introduction åŠŸèƒ½å°†ä½¿ä»£ç†å¯¹è±¡ç»§æ‰¿æ–°çš„æŽ¥å£ï¼Œä½†ç›®æ ‡å¯¹è±¡ï¼ˆä¸šåŠ¡å¯¹è±¡ï¼‰å´å¹¶æœªç»§æ‰¿ä»»ä½•æŽ¥å£ã€‚ bean åˆ‡å…¥: bean ç”¨æ¥é™å®šå¯¹è±¡çš„åç§°: 123456/** * ä»»æ„ä»¥Serviceä¸ºåŽç¼€çš„bean */ @Pointcut("bean(*Service)") public void beanOperation() &#123; &#125; @target åˆ‡å…¥: åŒ¹é…ä»»æ„ç›®æ ‡å¯¹è±¡æ ‡æ³¨äº†ç‰¹å®šæ ‡ç­¾: 123456/** * ä»»æ„ç›®æ ‡å¯¹è±¡æ ‡æ³¨äº†Transactionæ³¨è§£çš„æ–¹æ³• */@Pointcut("@target(me.Transaction)")public void targetAnnoationOperation() &#123;&#125; @within åˆ‡å…¥: åŒ¹é…ä»»æ„æ‹¥æœ‰ç‰¹å®šæ³¨è§£çš„ç±»åž‹: 123456/** * ä»»æ„æ ‡æ³¨äº†Transactionæ³¨è§£çš„ç±»çš„æ–¹æ³• */ @Pointcut("@within(me.Transaction)") public void withinAnnotationOperation() &#123; &#125; @annotation åˆ‡å…¥: åŒ¹é…ä»»æ„æ ‡æ³¨äº†ç‰¹å®šæ³¨è§£çš„æ–¹æ³•: 123456/** * ä»»æ„æ ‡æ³¨äº†Transactionæ³¨è§£çš„æ–¹æ³• */ @Pointcut("@annotation(me.Transaction)") public void annotationMethodOperation() &#123; &#125; @args åˆ‡å…¥: åŒ¹é…ä»»æ„å‚æ•°åˆ—è¡¨æ·»åŠ äº†ç‰¹å®šæ³¨è§£æ³¨é‡Šçš„æ–¹æ³•: 123456/** * ä»»æ„å‚æ•°åˆ—è¡¨åªæœ‰ä¸€ä¸ªå‚æ•°,ä¸”å‚æ•°æ ‡æ³¨äº†Transactionæ³¨è§£çš„æ–¹æ³• */ @Pointcut("@args(me.Transaction)") public void argsAnnotationMethodOperation() &#123; &#125; åˆ‡ç‚¹è”ç«‹è¡¨è¾¾è§„åˆ™: ä»»æ„å·²ç»å®šä¹‰çš„åˆ‡ç‚¹éƒ½å¯ä»¥ä½¿ç”¨é€»è¾‘å…³è”ç¬¦å·è”ç«‹è¡¨è¾¾å½¢æˆæ–°çš„ç¬¦åˆåˆ‡ç‚¹ï¼Œå¯ç”¨çš„é€»è¾‘å…³è”ç¬¦å·æœ‰ &amp;&amp;, ||, !. è”ç«‹è¡¨è¾¾è§æ ·ä¾‹å¦‚: 1234567891011121314151617181920212223242526272829/** * spring åˆ‡é¢ç¼–ç¨‹ */@Aspectpublic class AspectExample &#123; /** * åˆ‡å…¥ä»»æ„ public æ–¹æ³• */ @Pointcut("execution(public * *(..))") private void anyPublicOperator() &#123; &#125; /** * å®šä¹‰åœ¨ me.trading åŒ…ä¸‹çš„ä»»æ„æ–¹æ³• */ @Pointcut("within(me.trading..*)") private void inTrading() &#123; &#125; /** * ç»„åˆåˆ‡ç‚¹è¡¨è¾¾å¼,åˆ‡å…¥ä»»æ„ me.trading åŒ…ä¸‹çš„ public æ–¹æ³• */ @Pointcut("anyPublicOperator()||inTrading()") private void publicTrading() &#123; &#125;&#125; åœ¨ä¼ä¸šçº§åº”ç”¨å¼€å‘ä¸­å¾€å¾€éœ€è¦å®šä¹‰æœåŠ¡çº§åˆ«çš„å…¬ç”¨åˆ‡ç‚¹ï¼Œä¿è¯åˆ‡ç‚¹ç»Ÿä¸€ç®¡ç†ä¸Žå¯å¤ç”¨æ€§ã€‚ IV. Advice å£°æ˜ŽAdviceçš„ç±»åž‹å¦‚ä¹‹å‰æ‰€è¿°ï¼ŒAdvice å®šä¹‰äº†åˆ‡é¢çš„åˆ‡å…¥é€»è¾‘ï¼ŒæŒ‰ç…§åœ¨åˆ‡ç‚¹åƒçš„æ‰§è¡Œæ–¹å¼ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹äº”ç§ç±»åž‹: before advice: åªåœ¨åˆ‡ç‚¹ä¹‹å‰æ‰§è¡Œåˆ‡é¢ï¼Œè¯¥æ–¹å¼æ— æ³•æŽ§åˆ¶åŽŸä¸šåŠ¡æ–¹æ³•çš„è°ƒç”¨æ–¹å¼(é™¤äº†æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢è°ƒç”¨ä¹‹å¤–); after returning: åœ¨åˆ‡ç‚¹å®šä¹‰çš„æ–¹æ³•æ­£å¸¸ç»“æŸä¹‹åŽæ‰§è¡Œåˆ‡é¢; after throwing: åœ¨åˆ‡ç‚¹å› ä¸ºå¼‚å¸¸é€€å‡ºæ—¶æ‰§è¡Œåˆ‡é¢; after (finally): æ— è®ºåˆ‡ç‚¹ä»¥ä»€ä¹ˆå½¢å¼é€€å‡ºéƒ½ä¼šæ‰§è¡Œåˆ‡é¢; around: åˆ‡é¢é€»è¾‘å¯ä»¥ä¸»åŠ¨æŽ§åˆ¶æ–¹æ³•é€»è¾‘çš„è°ƒç”¨ï¼Œå¯ä»¥åœ¨æ–¹æ³•å‰åŽæ’å…¥ä»»æ„é€»è¾‘ã€‚è¿™ç§æ–¹å¼æ˜¾ç„¶æœ€ä¸ºå¼ºå¤§ï¼Œå› ä¸ºå®ƒç”šè‡³å¯ä»¥é˜»æ–­æ­£å¸¸è°ƒç”¨ï¼Œè¿”å›žè‡ªå·±ç‰¹å®šçš„ return value; spring AOP æä¾›äº†å®Œæ•´çš„ Advice ç±»åž‹ï¼Œä¹Ÿè®¸å¤§å®¶ä¼šè§‰å¾— around ç”¨èµ·æ¥ç®€ç›´çˆ½åˆ°çˆ†äº†, ä½†æ˜¯å€¼å¾—æé†’çš„æ˜¯æƒé™è¶Šå¤§è´£ä»»ä¹Ÿè¶Šå¤§ï¼Œéšä¹‹è€Œæ¥çš„é£Žé™©ä¹Ÿè¶Šå¤§äº†ï¼Œå› æ­¤å°½é‡åªé€‰æ‹©è¶³å¤ŸåŠŸèƒ½çš„ Advice ç±»åž‹æ‰æ˜¯çŽ‹é“å‘€ã€‚ @Before é€šçŸ¥å£°æ˜Ž: before ç±»åž‹çš„ Advice ä½¿ç”¨ @Before(pointcut expression) æ¥æ ‡æ³¨æ–¹æ³•å®žçŽ°ï¼š 1234567import org.aspectj.lang.annotation.Aspect; import org.aspectj.lang.annotation.Before;@Aspectpublic class BeforeExample &#123;// @Before("com.xyz.myapp.SystemArchitecture.dataAccessOperation()") é€šè¿‡åˆ‡ç‚¹å¼•ç”¨å£°æ˜Žåˆ‡å…¥åˆ‡å…¥ç‚¹ @Before("execution(* com.xyz.myapp.dao.*.*(..))") // é€šè¿‡åˆ‡ç‚¹è¡¨è¾¾å¼å£°æ˜Žåˆ‡å…¥ç‚¹ public void doAccessCheck() &#123; // ... &#125;&#125; @AfterReturning é€šçŸ¥å£°æ˜Ž: è§æ ·ä¾‹: 1234567import org.aspectj.lang.annotation.Aspect; import org.aspectj.lang.annotation.AfterReturning; @Aspect public class AfterReturningExample &#123; @AfterReturning("com.xyz.myapp.SystemArchitecture.dataAccessOperation()") public void doAccessCheck() &#123; // ... &#125; &#125; å¯èƒ½æˆ‘ä»¬å¸Œæœ›è®¿é—®æ–¹æ³•è¿”å›žçš„è¿”å›žå€¼ï¼Œæ­¤æ—¶å¯ä»¥ç”¨ returnning æŒ‡å®šè¿”å›žå€¼å‚æ•°åç§°: 12345678import org.aspectj.lang.annotation.Aspect;import org.aspectj.lang.annotation.AfterReturning;@Aspectpublic class AfterReturningExample &#123; @AfterReturning(pointcut="com.xyz.myapp.SystemArchitecture.dataAccessOperation()", returning="retVal")public void doAccessCheck(Object retVal) &#123; // ...&#125; &#125; @AfterThrowing é€šçŸ¥å£°æ˜Ž: è§æ ·ä¾‹: 123456import org.aspectj.lang.annotation.Aspect; import org.aspectj.lang.annotation.AfterThrowing;@Aspectpublic class AfterThrowingExample &#123; @AfterThrowing("com.xyz.myapp.SystemArchitecture.dataAccessOperation()")public void doRecoveryActions() &#123; // ...&#125; &#125; é€šå¸¸å¯ä»¥å®šä¹‰æŒ‡å®šå¼‚å¸¸ç±»åž‹çš„åˆ‡ç‚¹é€šçŸ¥ï¼Œä¸”éœ€è¦åœ¨æ‰§è¡Œé€»è¾‘ä¸­ä½¿ç”¨è¯¥å¼‚å¸¸å¯¹è±¡(æ–¹æ³•å‚æ•°çš„å¼‚å¸¸ç±»åž‹å¯ä»¥ä¸º Throwable) 12345678import org.aspectj.lang.annotation.Aspect; import org.aspectj.lang.annotation.AfterThrowing;@Aspectpublic class AfterThrowingExample &#123; @AfterThrowing( pointcut="com.xyz.myapp.SystemArchitecture.dataAccessOperation()", throwing="ex")public void doRecoveryActions(DataAccessException ex) &#123; // ...&#125; &#125; @After é€šçŸ¥å£°æ˜Ž: è§æ ·ä¾‹: 123456import org.aspectj.lang.annotation.Aspect; import org.aspectj.lang.annotation.After;@Aspectpublic class AfterFinallyExample &#123; @After("com.xyz.myapp.SystemArchitecture.dataAccessOperation()")public void doReleaseLock() &#123; // ...&#125; &#125; after é€šçŸ¥é€šå¸¸åœ¨æ–¹æ³•ç»“æŸåŽè¿è¡Œï¼Œå› æ­¤ä¸èƒ½ä»Žé€šçŸ¥é€»è¾‘ä¸­æŠ›å‡ºå¼‚å¸¸ã€‚è¯¥é€šçŸ¥é€šå¸¸ç”¨äºŽé‡Šæ”¾èµ„æº @Arround é€šçŸ¥å£°æ˜Ž: è§æ ·ä¾‹: 123456789import org.aspectj.lang.annotation.Aspect; import org.aspectj.lang.annotation.Around; import org.aspectj.lang.ProceedingJoinPoint;@Aspectpublic class AroundExample &#123; @Around("com.xyz.myapp.SystemArchitecture.businessService()")public Object doBasicProfiling(ProceedingJoinPoint pjp) throws Throwable &#123; // start stopwatchObject retVal = pjp.proceed();// stop stopwatchreturn retVal; &#125;&#125; ProceedingJoinPoint ç±»åž‹å‚æ•°æ˜¯aroundé€šçŸ¥çš„å¿…é¡»å‚æ•°ï¼Œ pip.proceed() å¯ä»¥è°ƒç”¨è¢«ä»£ç†æ–¹æ³•æ‰§è¡Œã€‚å› æ­¤åœ¨aroundé€šçŸ¥ä¸­ï¼Œè¢«ä»£ç†æ–¹æ³•æ˜¯å¦æ‰§è¡Œå®Œå…¨å–å†³äºŽä»£ç†é€»è¾‘ã€‚ V. Advice çš„å‚æ•°ç®¡ç†JoinPoint å‚æ•°: æ‰€æœ‰çš„ advice æ–¹æ³•éƒ½å¯ä»¥å°†ç¬¬ä¸€ä¸ªå‚æ•°å®šä¹‰ä¸ºorg.aspectj.lang.JoinPointç±»åž‹ï¼ˆaround adviceæ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ç±»åž‹æ˜¯ProceedingJoinPointï¼Œå®ƒæ˜¯JointPointçš„å­ç±»ï¼‰ï¼ŒJoinPoint å‚æ•°å°è£…äº†è®¸å¤šåŒ…å«ä»£ç†å¯¹è±¡åŠç›®æ ‡å¯¹è±¡ä¿¡æ¯èŽ·å–çš„æ–¹æ³•ï¼Œå¯¹äºŽä»£ç†é€»è¾‘ååˆ†æœ‰ç”¨ã€‚ å…¶ä»–ä¼ å…¥å‚æ•°: åœ¨ä¸Šé¢çš„ After Returnning Advice å’Œ After Throwing Advice æ ·ä¾‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»è§åˆ°äº†ä¸€äº›å¤–éƒ¨å‚æ•°ä¼ é€’æ–¹å¼ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆä½¿ç”¨ args pointcut æ¥æ¼”ç¤ºå¦‚ä½•ä¼ é€’å¤–éƒ¨å‚æ•°: 12345@Pointcut("com.xyz.myapp.SystemArchitecture.dataAccessOperation() &amp;&amp; args(account,..)")private void accountDataAccessOperation(Account account) &#123;&#125;@Before("accountDataAccessOperation(account)")public void validateAccount(Account account) &#123; // ...&#125; ä¸Šé¢æ ·ä¾‹ä¸­ validateAccount æ–¹æ³•çš„å‚æ•°åˆ—è¡¨å®šä¹‰äº† Account account å‚æ•° å’Œ args pointcut å®šä¹‰çš„å‚æ•°åç§°ä¸€è‡´ï¼ˆå›žé¡¾ä¸€ä¸‹ args pointcut å®šä¹‰çš„æ˜¯è¿è¡Œæ—¶ä¼ å…¥å‚æ•°ç±»åž‹ï¼Œè¿™é‡Œåªå®šä¹‰äº†å‚æ•°åç§°ï¼‰ï¼Œspring AOP æ¡†æž¶å°†æ ¹æ® æ–¹æ³•å‚æ•°çš„ç±»åž‹æ¥ç¡®å®š args å‚æ•°é™å®šç±»åž‹ï¼ŒåŒæ—¶ä»Žç¬¦åˆé™å®šçš„æ–¹æ³•è°ƒç”¨ä¸­ä¼ é€’å‚æ•°ç»™ advice æ–¹æ³•ã€‚ å…¶ä»–pointcutç±»åž‹çš„å‚æ•°ä¼ é€’ä¹Ÿæ˜¯ç±»ä¼¼çš„: 1234@Retention(RetentionPolicy.RUNTIME) @Target(ElementType.METHOD)public @interface Auditable &#123; AuditCode value();&#125; 123@Before("com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; @annotation(auditable)")public void audit(Auditable auditable) &#123; AuditCode code = auditable.value(); // ...&#125; æ³›åž‹å‚æ•°ä¼ é€’: spring AOP åœ¨å‚æ•°ä¼ é€’ä¸­ä¹Ÿæ”¯æŒæ³›åž‹å¤„ç†ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰æ³›åž‹ç±»åž‹å¦‚ä¸‹: 1234public interface Sample&lt;T&gt; &#123;void sampleGenericMethod(T param);void sampleGenericCollectionMethod(Collection&lt;T&gt; param);&#125; æŽ¥ç€å®šä¹‰åˆ‡é¢é€»è¾‘ï¼Œå› ä¸ºéœ€è¦ä¼ é€’å‚æ•°ï¼Œæˆ‘ä»¬éœ€è¦é™å®šå‚æ•°çš„å®žé™…ç±»åž‹: 123@Before("execution(* ..Sample+.sampleGenericMethod(*)) &amp;&amp; args(param)")public void beforeSampleMethod(MyType param) &#123; // Advice implementation&#125; æ˜¾ç„¶è¿™ç§åˆ‡é¢å®šä¹‰æ˜¯åˆ‡å®žå¯è¡Œçš„ï¼Œä½†æ˜¯è¿™ç§å‚æ•°ç±»åž‹é™å®šåœ¨æ³›åž‹ç±»ä¸­å¯èƒ½ä¼šé‡åˆ°éº»çƒ¦ã€‚æ¯”å¦‚æˆ‘ä»¬å®šä¹‰å¦‚ä¸‹åˆ‡é¢: 123@Before("execution(* ..Sample+.sampleGenericCollectionMethod(*)) &amp;&amp; args(param)")public void beforeSampleMethod(Collection&lt;MyType&gt; param) &#123; // Advice implementation&#125; æ­¤æ—¶ä¸ºäº†æ ¡éªŒè¿è¡Œæ—¶å‚æ•°ï¼Œ Spring AOP å°†æ ¡éªŒå‚æ•°å®¹å™¨ä¸­æ¯ä¸ªå…ƒç´ çš„ç±»åž‹ï¼Œä½†è¿™æ ·åšå¹¶ä¸é è°±å‘€ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“å®¹å™¨ä¸­çš„nullå¯¹è±¡æ˜¯å¦å±žäºŽé™å®šçš„ç±»åž‹ â€¦ å› æ­¤ï¼Œspring AOP ä½¿ç”¨äº†ä¸€ç§è¿‘ä¼¼å½¢å¼çš„ä¼ é€’å½¢å¼: å°†å‚æ•°äº†ç±»åž‹æŒ‡å®šä¸º Collection&lt;?&gt;, å°†å…ƒç´ çš„ç±»åž‹æ ¡éªŒäº¤ç»™å’±ä»¬å•¦ ^ ^ã€‚ å‚æ•°åç§°çš„å®šä¹‰: ä¹Ÿè®¸æœ‰äººå·²ç»å‘çŽ°ï¼Œå®šä¹‰åœ¨Adviceæ–¹æ³•ä¸­çš„å‚æ•°åç§°å¹¶ä¸ä¼šåœ¨è¿è¡Œæ—¶èŽ·å¾—çš„å‘€ï¼Œé‚£ spring AOP æ˜¯å¦‚ä½•è¿›è¡Œåç§°åŒ¹é…çš„å˜›ðŸ˜¹ï¼ï¼Ÿ ä¸æ‰“ç´§ï¼Œspring AOP å·²ç»è€ƒè™‘åˆ°äº†ï¼Œå®ƒæä¾›äº† ä¸‰ç§ç­–ç•¥ è¿›è¡Œå‚æ•°ååŒ¹é…: ä½¿ç”¨ argNames å‚æ•°åˆ—è¡¨: ç›´æŽ¥ä¸Šä»£ç  12345 @Before(value="com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)", argNames="bean,auditable")public void audit(Object bean, Auditable auditable) &#123; AuditCode code = auditable.value();// ... use code and bean&#125; çœ‹å‡ºç«¯å€ªäº†å—ï¼ŸargNames ç”¨ä¸€ä¸ªé€—å·é—´éš”çš„å­—ç¬¦ä¸²å®šä¹‰äº†å®Œæ•´çš„å‚æ•°åç§°åˆ—è¡¨(æ³¨æ„å®šä¹‰é¡ºåºå“ˆ~) å…¶å®žè¿˜æœ‰æ›´å¼ºå¤§çš„æ–¹å¼: 12345@Before(value="com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; target(bean) &amp;&amp; @annotation(auditable)", argNames="bean,auditable") public void audit(JoinPoint jp, Object bean, Auditable auditable) &#123; AuditCode code = auditable.value(); // ... use code, bean, and jp&#125; JoinPoint å‚æ•°ä½œä¸º Advice æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°å¹¶æ²¡æœ‰åœ¨ argNames ä¸­æ˜¾ç¤ºå®šä¹‰å…¶åç§°ã€‚æ˜¯çš„ï¼Œé»˜è®¤æ˜¯å¯ä»¥çœç•¥çš„ðŸ‘Šã€‚è¿™è®©æˆ‘ä»¬ç å†œæ–¹ä¾¿äº†ä¸å°‘å‘€ ^ ^ã€‚ èŽ·å–ç±»çš„debugä¿¡æ¯: å†™ argNames æ€»è¿˜æ˜¯æœ‰äº›éº»çƒ¦ï¼Œå½“ç¨‹åºå‘˜æœªå®šä¹‰è¿™ä¸ªå˜é‡æ—¶ï¼Œspring AOP å°†å°è¯•èŽ·å–è¯¥ç±»çš„ debug ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯åœ¨ç¼–è¯‘åŽé»˜è®¤æ˜¯ä¸ä¼šä¿ç•™çš„ï¼Œéœ€è¦æ˜¾å¼åœ¨ç¼–è¯‘æ—¶é©¾é©¶ -g:vars å‚æ•°ã€‚å¢žåŠ è¿™ä¸ªå‚æ•°ä¼šäº§ç”Ÿçš„ç»“æžœ: ä»£ç å› ä¸ºæ²¡æœ‰ argNames å‚æ•°ä¼šç•¥å¾®æ˜“è¯»ä¸€äº›; ç¼–è¯‘åŽç”Ÿæˆçš„classæ–‡ä»¶ä¼šç•¥å¾®å¤§ä¸€äº›; ç¼–è¯‘é˜¶æ®µåŽŸæœ‰å¯¹æœªä½¿ç”¨æœ¬åœ°å˜é‡çš„ä¼˜åŒ–çš„åŠŸèƒ½å°†ä¸å†æ‰§è¡Œ; æ€»è€Œè¨€ä¹‹ï¼Œç¼–è¯‘æ—¶å¢žåŠ è¯¥æ ‡è®°å¹¶ä¸ä¼šå¯¹é¡¹ç›®æœ‰å¤šå°‘å½±å“ã€‚ ç®€å•åç§°æŽ¨æ–­: ä¸Šé¢ä¸¤æ­¥éƒ½æ²¡åšï¼Œé‚£å°±åªèƒ½é spring AOP è‡ªå·±åŽ»çŒœï¼ˆæŽ¨æ–­ï¼‰å•¦ ~ springçš„æŽ¨æ–­åªæ˜¯ç®€å•ä¾æ®å‚æ•°ä¸ªæ•°è¿›è¡ŒåŒ¹é…ï¼Œä¾‹å¦‚åªå®šä¹‰äº†ä¸€ä¸ªå‚æ•°ï¼Œé‚£è¿˜ç”¨å•¥åç§°åŒ¹é…å‘¢ï¼ˆ^ ^ï¼‰ï¼Ÿ è¿˜ä¸è¡Œé‚£å°±æŠ›é”™å§: æ²¡é”™, å†ä¸è¡Œspring AOPå°±ä¼šæŠ›å‡º IllegalArgumentException å¼‚å¸¸ã€‚ è°ƒç”¨åŽŸæ–¹æ³•æ—¶çš„å‚æ•°ä¼ é€’: è¿™é‡Œæ— éœ€å¤šè¯´ï¼Œåªéœ€è¦æŒ‰é¡ºåºåˆ›å»ºå‚æ•°åˆ—è¡¨æ•°ç»„å¹¶ä¼ é€’ç»™ proceed() æ–¹æ³•å³å¯: 123456@Around("execution(List&lt;Account&gt; find*(..)) &amp;&amp; " + "com.xyz.myapp.SystemArchitecture.inDataAccessLayer() &amp;&amp; " + "args(accountHolderNamePattern)")public Object preProcessQueryPattern(ProceedingJoinPoint pjp, String accountHolderNamePattern) throws Throwable &#123; String newPattern = preProcess(accountHolderNamePattern);return pjp.proceed(new Object[] &#123;newPattern&#125;); &#125; å¤šä¸ªAdvice åœ¨ä¸€ä¸ª join point å¤„çš„æ‰§è¡Œé¡ºåº: å¦‚æžœåœ¨ä¸€ä¸ª join point å¤„æœ‰å¤šä¸ª adviceï¼ŒSpring AOP é‡‡ç”¨å’Œ AspectJ ç±»ä¼¼çš„ä¼˜å…ˆçº§æ¥æŒ‡å®šé€šçŸ¥çš„æ‰§è¡Œé¡ºåºã€‚ç›®æ ‡å‡½æ•°è°ƒç”¨å‰ï¼Œä¼˜å…ˆçº§é«˜çš„adviceå…ˆæ‰§è¡Œï¼Œç›®æ ‡å‡½æ•°è°ƒç”¨åŽï¼Œä¼˜å…ˆçº§é«˜çš„adviceåŽæ‰§è¡Œã€‚ å¦‚æžœä¸¤ä¸ªé€šçŸ¥åˆ†åˆ«å®šä¹‰åœ¨å„è‡ªçš„ Aspect å†…ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹ä¸¤ç§æ–¹å¼æŽ§åˆ¶ Aspect çš„æ–½åŠ é¡ºåºï¼š Aspect ç±»æ·»åŠ æ³¨è§£æŒ‡å®šé¡ºåºå€¼ï¼šorg.springframework.core.annotation.Order Aspect ç±»å®žçŽ°æŽ¥å£é€šè¿‡getOrder()æ–¹æ³•æŒ‡å®šé¡ºåºå€¼ï¼šorg.springframework.core.Ordered é¡ºåºå€¼æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œæ•°å€¼è¶Šå°ä»£è¡¨çš„ä¼˜å…ˆçº§è¶Šå¤§ å¦‚æžœä¸¤ä¸ª advice ä½äºŽåŒä¸€ aspect å†…ï¼Œä¸”æ‰§è¡Œé¡ºåºæœ‰å…ˆåŽï¼Œé€šè¿‡ advice çš„å£°æ˜Žé¡ºåºæ˜¯æ— æ³•ç¡®å®šå…¶æ‰§è¡Œé¡ºåºçš„ï¼Œå› ä¸º advice æ–¹æ³•çš„å£°æ˜Žé¡ºåºæ— æ³•é€šè¿‡åå°„èŽ·å–ï¼Œåªèƒ½é‡‡å–å¦‚ä¸‹å˜é€šæ–¹å¼ï¼ŒäºŒé€‰ä¸€ï¼š å°†ä¸¤ä¸ª advice åˆå¹¶ä¸ºä¸€ä¸ª adviceï¼Œé‚£ä¹ˆæ‰§è¡Œé¡ºåºå°±å¯ä»¥é€šè¿‡ä»£ç æŽ§åˆ¶äº† å°†ä¸¤ä¸ª advice åˆ†åˆ«æŠ½ç¦»åˆ°å„è‡ªçš„ aspect å†…ï¼Œç„¶åŽä¸º aspect æŒ‡å®šæ‰§è¡Œé¡ºåº introduction å¼•å…¥åŠŸèƒ½ Introduction å¼•å…¥åŠŸèƒ½ å°†ä½¿è¢«ä»£ç†çš„å¯¹è±¡æ‹¥æœ‰é¢å¤–æŽ¥å£ï¼Œä½¿å…¶æ— éœ€ç»§æ‰¿ä¾¿æ‹¥æœ‰ç‰¹å®šæŽ¥å£çš„ç‰¹å®šå®žçŽ°ã€‚Introduction ä½¿ç”¨ @DeclareParentsæ³¨è§£å®šä¹‰å¼•å…¥çš„æŽ¥å£å’Œå®žçŽ°ã€‚ä¸‹é¢è´´å‡ºæ ·ä¾‹æ¥åˆ†æžå¼•ç”¨è¿‡ç¨‹: 123456789@Aspectpublic class UsageTracking &#123; @DeclareParents(value="com.xzy.myapp.service.*+", defaultImpl=DefaultUsageTracked.class) public static UsageTracked mixin; @Before("com.xyz.myapp.SystemArchitecture.businessService() &amp;&amp; this(usageTracked)") public void recordUsage(UsageTracked usageTracked) &#123; usageTracked.incrementUseCount();&#125; &#125; ä¸Šé¢æ ·ä¾‹ä¸­ UsageTracked æ˜¯ä¸€ä¸ªæŽ¥å£, DefaultUsageTracked æ˜¯è¯¥æŽ¥å£çš„ä¸€ä¸ªå®žçŽ°ç±»ã€‚ä¸Šé¢å®šä¹‰çš„@DeclareParents(value=&quot;com.xzy.myapp.service.*+&quot;, defaultImpl=DefaultUsageTracked.class)å£°æ˜Žäº†com.xzy.myapp.serviceåŒ…ä¸‹çš„æ‰€æœ‰ç±»éƒ½å°†å¼•å…¥UsageTrackedæŽ¥å£çš„åŠŸèƒ½ï¼Œé»˜è®¤æ‰§è¡ŒDefaultUsageTracked.classç±»çš„å®žçŽ°é€»è¾‘ã€‚ æ€»ç»“æœ¬æ¬¡åªæ˜¯ç®€å•äº†è§£äº† AOP çš„åŸºæœ¬æ¦‚å¿µä»¥åŠå…¶ä½¿ç”¨æ–¹å¼ï¼Œå¯ä»¥è¯´é™¤äº†æ¦‚å¿µè¾ƒä¸°å¯Œä¹‹å¤–å¹¶æ— è¿‡å¤šéš¾åº¦ã€‚åŽç»­å°†è¿›ä¸€æ­¥æ¢³ç† spring AOP çš„æ›´å¤šå†…å®¹ï¼ŒåŒ…æ‹¬ spring AOP API, spring AOP å®žçŽ°åŽŸç†, spring AOP åº”ç”¨åœºæ™¯å®žè·µç­‰ã€‚æ¬¢è¿Žå„ä½å°ä¼™ä¼´å¤šææ„è§ ^ ^ã€‚]]></content>
    </entry>

    
    <entry>
      <title><![CDATA[CGLIB åŠ¨æ€ä»£ç†åˆè®²]]></title>
      <url>%2F2017%2F02%2F07%2FCGLIB-1%2F</url>
      <content type="text"><![CDATA[ç®€è¿°: CGLIB (Code Generation Library) åº•å±‚åŸºäºŽ ASM å­—èŠ‚ç å¤„ç†æ¡†æž¶, èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶ç”Ÿæˆæ–°çš„javaå­—èŠ‚ç ï¼Œå› æ­¤åœ¨åŠ¨æ€ä»£ç†æ–¹é¢ä½¿ç”¨å¹¿æ³›ã€‚ç›¸å¯¹äºŽ JDK åŽŸç”ŸåŠ¨æ€ä»£ç†, å®ƒæ— éœ€ä¾èµ–æŽ¥å£ï¼Œèƒ½å¤Ÿå¯¹ä»»æ„ç±»ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚ ä¸€ã€CGLIB å®žçŽ°åŠ¨æ€ä»£ç†çš„ä¸€èˆ¬æ­¥éª¤ åœ¨ CGLIB ä¸­å­˜åœ¨ä¸€ä¸ªå…³é”®ç±» Enhancerã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œä»£ç†è¦å¯¹åŽŸæœ‰å¯¹è±¡å¯¹å¤–æš´éœ²åŠŸèƒ½è¿›è¡Œæ‰˜ç®¡å’Œå¢žå¼ºï¼Œå¯¹äºŽä¸€ä¸ªä¸šåŠ¡å¯¹è±¡ï¼Œç‹­ä¹‰ä¸Šçš„å¯¹å¤–å¥‘çº¦å¯ä»¥è®¤ä¸ºæ˜¯ä¸šåŠ¡æŽ¥å£ï¼Œä½†æ˜¯å¹¿ä¹‰è€Œè¨€ï¼Œä»»æ„å¯¹è±¡çš„ public æ–¹æ³•éƒ½å¯ä»¥è®¤ä¸ºæ˜¯æš´éœ²äºŽå¤–éƒ¨çš„å¥‘çº¦ã€‚å› æ­¤åœ¨ CGLIB ä¸­ï¼Œå…¶ä»£ç†ç±»çš„åˆ›å»ºå¯ä»¥ä¾èµ–ä»»æ„ç±»(åŒºåˆ«äºŽ JDK åŽŸç”ŸåŠ¨æ€ä»£ç† çš„é¢å‘æŽ¥å£ä»£ç†)ã€‚ CGLIB åŠ¨æ€ä»£ç†å®žçŽ°çš„ç®€å•æ­¥éª¤å¦‚ä¸‹: 123456Enhancer enhancer = new Enhancer(); // åˆ›å»ºå¢žå¼ºå™¨enhancer.setSuperclass(businessObject.getClass()); // è®¾ç½®è¢«ä»£ç†ç±»enhancer.setCallback(callBackLogic); // è®¾ç½®ä»£ç†é€»è¾‘Business businessProxy = (Business)enhancer.create(); // åˆ›å»ºä»£ç†å¯¹è±¡ businessProxy.doBusiness(); // ä¸šåŠ¡è°ƒç”¨ ä¸Šé¢æ­¥éª¤ä¸­ callBackLogic æ˜¯ä»£ç†é€»è¾‘è°ƒç”¨å™¨å¯¹è±¡ï¼Œå®šä¹‰äº†å…·ä½“ä»£ç†åˆ‡å…¥é€»è¾‘ã€æ–¹æ³•è°ƒç”¨æ–¹å¼ç­‰ï¼Œä¸º CGLIB ä¸­ Callback æŽ¥å£çš„å®žä¾‹ã€‚CGLIB ä¸­æœ‰è®¸å¤šä¸åŒçš„ CallBack å­æŽ¥å£ï¼Œå¯¹åº”äº†å„ç§ä¸åŒåŠŸèƒ½çš„ä»£ç†é€»è¾‘ã€‚ CallBack å­æŽ¥å£å±•ç¤º: äºŒã€CGLIB åŠ¨æ€ä»£ç†å®žçŽ°æ ·ä¾‹è€è¯è®²,å”¯æœ‰å®žæˆ˜æ‰æ˜¯ç£¨ç‚¼æŠ€èƒ½çš„å”¯ä¸€æ ‡å‡†ï¼ŒæŽ¥ä¸‹æ¥æˆ‘ä»¬æ ¹æ®ä¸€äº›ç®€å•æ ·ä¾‹åˆ†æž CGLIB çš„ç‰¹æ€§: ä¾èµ–é…ç½® maven ä¾èµ–é…ç½®: 1234567&lt;!--cglib maven ä¾èµ–--&gt;&lt;dependency&gt; &lt;groupId&gt;cglib&lt;/groupId&gt; &lt;artifactId&gt;cglib&lt;/artifactId&gt; &lt;version&gt;3.2.4&lt;/version&gt;&lt;/dependency&gt; FixedValue ä»£ç†é€»è¾‘è°ƒç”¨å™¨ åŠŸèƒ½ä»‹ç»: FixedValue å¢žå¼ºå™¨å°†ä¸ºç›®æ ‡ç±»(åŒ…å«ç›®æ ‡ç±»çš„çˆ¶ç±»)çš„æ‰€æœ‰æ–¹æ³•(å‡†ç¡®è€Œè¨€åº”è¯¥æ˜¯éžstaticä¸”éžfinalçš„publicæ–¹æ³•)è®¾ç½®å›ºå®šè¿”å›žå€¼ã€‚åœ¨ä»£ç†å¯¹è±¡è°ƒç”¨ä»»ä¸€æ–¹æ³•æ—¶,é¢„è®¾ç½®çš„è¿”å›žå€¼å°†è¢«å¼ºåˆ¶è½¬æ¢æˆå¯¹åº”æ–¹æ³•å®šä¹‰çš„è¿”å›žå€¼ç±»åž‹ã€‚å› æ­¤ï¼Œå½“ç±»åž‹æ— æ³•å¼ºåˆ¶è½¬æ¢æ—¶ä¼šæŠ›å‡º ClassCastException å¼‚å¸¸; æ ·ä¾‹ä»£ç å±•ç¤º: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667import net.sf.cglib.proxy.Enhancer;import net.sf.cglib.proxy.FixedValue;/** * FixedValue æµ‹è¯• */public class CglibFixedValue &#123; public static void testFixedValue() &#123; Business business = new Business(); /** * åˆå§‹åŒ–å¢žå¼ºå™¨ * */ Enhancer enhancer = new Enhancer(); // åˆ›å»ºå¢žå¼ºå™¨ enhancer.setSuperclass(business.getClass()); enhancer.setCallback((FixedValue) () -&gt; "do business by proxy"); /** * åˆ›å»ºä»£ç†å¯¹è±¡ * */ Business businessPrxy = (Business) enhancer.create(); System.out.println(business.doBusiness()); System.out.println(businessPrxy.doBusiness()); // System.out.println(businessPrxy.hashCode()); // err: ClassCastException /** * åˆ›å»ºä»£ç†å¢žå¼ºç±»çš„ç±»åž‹ * */ Class cls = enhancer.createClass(); System.out.println(cls.getSuperclass().equals(business.getClass())); // Date datePrxy = (Date) enhancer.create(); // err: ClassCastException &#125; public static void main(String... args) &#123; testFixedValue(); &#125; /** ä¸šåŠ¡ç±»å®šä¹‰ */ private static class Business &#123; public Business() &#123; &#125; // é™æ€æ–¹æ³• public static String staticDoBusiness() &#123; return "staticDoBusiness"; &#125; public String doBusiness() &#123; return "doBusiness"; &#125; final public String finalDoBusiness() &#123; return "finalDoBusiness"; &#125; private String privateDoBusiness()&#123; return "privateDoBusiness"; &#125; protected String protectedDoBusiness()&#123; return "protectedDoBusiness"; &#125; &#125;&#125; è¿è¡Œç»“æžœå¦‚ä¸‹: 1234éžä»£ç†å¯¹è±¡ä¸šåŠ¡è°ƒç”¨: doBusinessä¸šåŠ¡æ–¹æ³•ä»£ç†è°ƒç”¨: do business by proxyçˆ¶ç±»æ–¹æ³•ä»£ç†è°ƒç”¨: do business by proxyä»£ç†å¢žå¼ºç±»æ˜¯å¦æ˜¯ä¸šåŠ¡ç±»çš„å­ç±»: true æ­£å¦‚å¼€å§‹æè¿°ï¼ŒFixedValue å°†ä¼šè®¾ç½®ç›®æ ‡ç±»åŠå…¶çˆ¶ç±»ä¸­çš„æ–¹æ³•è¿”å›žå›ºå®šå€¼ã€‚ä»£ç æ ·ä¾‹ä¸­æ³¨é‡Šéƒ¨åˆ†è°ƒç”¨å°†äº§ç”Ÿç±»åž‹è½¬æ¢å¼‚å¸¸ã€‚éœ€è¦æ³¨æ„çš„æ˜¯Business ç±»ä¸­å®šä¹‰äº†é™æ€æ–¹æ³•(staticDoBusiness),finalæ–¹æ³•(finalDoBusiness),privateæ–¹æ³•(privateDoBusiness)å’Œprotectedæ–¹æ³•(protectedDoBusiness),æˆ‘åœ¨debugæ¨¡å¼ä½¿ç”¨æŽ§åˆ¶å°ç›‘æŽ§å™¨è°ƒç”¨ç»“æžœå¦‚ä¸‹: æ˜¾ç„¶è¿™äº›æ–¹æ³•éƒ½æœªè¢«ä»£ç†é‡å†™ã€‚è¿™æ˜¯å› ä¸º CGLIB åªä¼šå¯¹ éžfinalä¸”éžstaticçš„publicæ–¹æ³• è¿›è¡Œä»£ç†é€»è¾‘é‡å†™ã€‚ InvocationHandler ä»£ç†é€»è¾‘è°ƒç”¨å™¨ CGLIB å’Œ JDKåŽŸç”ŸåŠ¨æ€ä»£ç† ä¸€æ ·ä¹Ÿæ”¯æŒ InvocationHandler å½¢å¼çš„åŠ¨æ€ä»£ç†, å…¶å®žçŽ°æ ·ä¾‹å¦‚ä¸‹: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758import net.sf.cglib.proxy.Enhancer;import net.sf.cglib.proxy.InvocationHandler;import java.lang.reflect.Method;/** * invocationHandler ä»£ç†é€»è¾‘è°ƒç”¨å™¨ */public class CglibInvocationHandler &#123; public static void main(String... args) &#123; Business business = new Business(); Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(business.getClass()); enhancer.setCallback(new InvocationHandler() &#123; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; Object rt = null; System.out.println("do before business"); if (method.getReturnType().equals(String.class)) &#123; rt = method.invoke(business, args); &#125; else &#123; rt = "æœªçŸ¥è°ƒç”¨"; /** * ä¸èƒ½ç›´æŽ¥è°ƒç”¨proxyå¯¹è±¡çš„methodæ–¹æ³•, å°†ä¼šäº§ç”Ÿæ­»å¾ªçŽ¯ * */ // method.invoke(proxy, args); &#125; System.out.println("do after business"); return rt; &#125; &#125;); Business businessProxy = (Business) enhancer.create(); businessProxy.doBusiness(); &#125; /** * ä¸šåŠ¡ç±» */ private static class Business &#123; public Business() &#123; &#125; public String doBusiness() &#123; System.out.println("do business"); return "do business"; &#125; &#125;&#125; ä»Žæ ·ä¾‹ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œå’Œ JDKåŽŸç”ŸåŠ¨æ€ä»£ç† ä¸€æ ·ï¼Œä»£ç†é€»è¾‘éƒ½æ˜¯è¦†å†™ InvocationHandler æŽ¥å£ä¸­çš„ invoke æ–¹æ³•å®žçŽ°çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹åŽŸå§‹æ–¹æ³•çš„è°ƒç”¨å¿…é¡»æ˜¾å¼å¼•å…¥å…·ä½“è¢«ä»£ç†çš„å¯¹è±¡(ä¸šåŠ¡å¯¹è±¡)ï¼Œå¯¹ä»£ç†å¯¹è±¡proxyç›´æŽ¥ä½¿ç”¨method.invoke(proxy, args)è¿›è¡Œæ–¹æ³•è°ƒç”¨å°†äº§ç”Ÿæ— é™æ­»å¾ªçŽ¯!å›žé¡¾ä¸€ä¸‹JDKåŽŸç”ŸåŠ¨æ€ä»£ç†ï¼Œåº”è¯¥ä¹Ÿå­˜åœ¨ç±»ä¼¼çš„é—®é¢˜ã€‚å› æ­¤ InvocationHandler åœ¨å®žé™…åº”ç”¨åœºæ™¯ä¸‹å¹¶ä¸å¸¸ç”¨ï¼ŒæŽ¥ä¸‹æ¥ä»‹ç»çš„ MethodInterceptor å°†ä¼šè§£å†³è¿™ä¸ªé—®é¢˜ã€‚ MethodInterceptor ä»£ç†é€»è¾‘è°ƒç”¨å™¨ MethodInterceptor ä»£ç†é€»è¾‘è°ƒç”¨å™¨æ˜¯æœ€å¸¸ç”¨çš„ä»£ç†æ–¹å¼ï¼Œå…¶è°ƒç”¨æ ·ä¾‹å¦‚ä¸‹: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364import net.sf.cglib.proxy.Enhancer;import net.sf.cglib.proxy.MethodInterceptor;import net.sf.cglib.proxy.MethodProxy;import java.lang.reflect.Method;/** * MethodInterceptor ä»£ç†é€»è¾‘è°ƒç”¨å™¨ */public class CglibMethodInterceptor &#123; public static void main(String... args) &#123; Business business = new Business(); Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(business.getClass()); enhancer.setCallback(new MethodInterceptor() &#123; @Override public Object intercept( Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable &#123; Object rt; System.out.println("===\ndo before business"); if (method.getReturnType().equals(String.class)) &#123; rt = proxy.invokeSuper(obj, args); // è°ƒç”¨åŽŸå§‹æ–¹æ³•(è¢«ä»£ç†ä¸šåŠ¡å¯¹è±¡çš„æ–¹æ³•) &#125; else &#123; rt = "æœªçŸ¥è°ƒç”¨"; System.out.println(rt); &#125; System.out.println("do after business"); return rt; &#125; &#125;); Business businessProxy = (Business) enhancer.create(); System.out.println(businessProxy.doBusiness()); businessProxy.doBusiness("do business"); &#125; /** * ä¸šåŠ¡ç±» */ private static class Business &#123; public Business() &#123; &#125; public String doBusiness() &#123; System.out.println("do business"); return "business return value"; &#125; public void doBusiness(String arg) &#123; System.out.println(arg); &#125; &#125;&#125; å’Œ InvocationHandler å¯¹æ¯”è€Œè¨€ï¼Œå…¶ä»£ç†æ–¹æ³• intercept çš„å‚æ•°åˆ—è¡¨ä¸­å¤šå‡ºä¸€ä¸ª MethodProxy proxy å‚æ•°ã€‚proxy å‚æ•°æ˜¯è¢«ä»£ç†ç±»æ‰˜ç®¡æ–¹æ³•çš„å°è£…ã€‚æ ·ä¾‹ä¸­ proxy.invokeSuper(obj, args); è¿™å¥ä»£ç å°±å®žçŽ°äº†å¯¹åŽŸå§‹æ–¹æ³•çš„è°ƒç”¨ï¼Œç‰¹åˆ«æŒ‡å‡ºçš„æ˜¯è¯¥è°ƒç”¨å¹¶ä¸ä¾èµ–åŽŸå§‹å¯¹è±¡çš„å¼•ç”¨ï¼ˆå…¶ä¸­çš„objå¯¹è±¡æ˜¯ä»£ç†å¯¹è±¡ï¼‰ï¼Œä¹Ÿä¸ä¼šåƒ InvocationHandler ä¸€æ ·é€ æˆ invoke æ­»å¾ªçŽ¯é£Žé™©ã€‚ ä¸Šé¢æ ·ä¾‹æ‰§è¡Œç»“æžœå¦‚ä¸‹: 123456789===do before businessdo businessdo after businessbusiness return value===do before businessæœªçŸ¥è°ƒç”¨do after business LazyLoader ä»£ç†é€»è¾‘è°ƒç”¨å™¨ å»¶è¿ŸåŠ è½½å°†å®šä¹‰ä¸€ä¸ªä»£ç†åˆ›å»ºè¿‡ç¨‹ï¼Œè¿”å›žè¢«ä»£ç†ç±»åž‹çš„ä¸€ä¸ªå¯¹è±¡å®žä¾‹ã€‚å»¶è¿ŸåŠ è½½æ ·ä¾‹ä»£ç å¦‚ä¸‹: 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556import net.sf.cglib.proxy.Enhancer;import net.sf.cglib.proxy.LazyLoader;/** * LazyLoader ä»£ç†é€»è¾‘è°ƒç”¨å™¨ */public class CglibLazyLoader &#123; public static void main(String... args) &#123; Business business = lazyLoadString("hello world"); System.out.println("é¦–æ¬¡è°ƒç”¨å¯¹è±¡"); System.out.println(business.getProperty()); System.out.println("å†æ¬¡è°ƒç”¨å¯¹è±¡"); System.out.println(business.getProperty()); &#125; /** * å»¶è¿ŸåŠ è½½æ–¹æ³• */ public static Business lazyLoadString(String msg) &#123; Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(Business.class); enhancer.setCallback(new LazyLoader() &#123; @Override public Object loadObject() throws Exception &#123; System.out.println("å»¶è¿ŸåŠ è½½è°ƒç”¨"); return new Business(msg); &#125; &#125;); Business business = (Business) enhancer.create(); return business; &#125; public static class Business &#123; private String property; public Business() &#123; &#125; public Business(String property) &#123; this.property = property; &#125; public String getProperty() &#123; return property; &#125; public void setProperty(String property) &#123; this.property = property; &#125; &#125;&#125; ä»£ç†é€»è¾‘æ–¹æ³•çš„ç­¾åæ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Ÿæ²¡é”™ï¼Œè¿™ä¸ª public Object loadObject() throws Exception å’Œ FixedValue ä¸­çš„æ–¹æ³•ç­¾åæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ä»–ä»¬çš„åŠŸèƒ½å´æˆªç„¶ä¸åŒã€‚åœ¨ LazyLoader ä¸­ï¼Œä»–è´Ÿè´£åˆ›å»ºå¹¶è¿”å›žä¸€ä¸ªä¸šåŠ¡å¯¹è±¡çš„å®žä¾‹ã€‚è¯¥æ ·ä¾‹çš„è¿è¡Œç»“æžœå¦‚ä¸‹: 12345é¦–æ¬¡è°ƒç”¨å¯¹è±¡å»¶è¿ŸåŠ è½½è°ƒç”¨hello worldå†æ¬¡è°ƒç”¨å¯¹è±¡hello world çœ‹æ¥ Business business = lazyLoadString(&quot;hello world&quot;); å¹¶æ²¡æœ‰æ­£çœŸåˆ›å»ºBusinesså®žä¾‹, è€Œæ˜¯åœ¨ä»£ç†å¯¹è±¡ç¬¬ä¸€æ¬¡è¿›è¡Œæ–¹æ³•è°ƒç”¨æ—¶æ‰æ­£çœŸè§¦å‘å®žä¾‹åˆ›å»ºæ“ä½œã€‚å¯æƒ³è€ŒçŸ¥ LazyLoader çš„åŠŸèƒ½äº†å§ ^ ^ã€‚ Dispatcher ä»£ç†é€»è¾‘è°ƒç”¨å™¨ Dispatcher æŽ¥å£ç”¨æ¥å®šä¹‰ä¸€ä¸ªå¯åˆ†å‘å¯¹è±¡ï¼Œå®ƒéœ€è¦ä½¿ç”¨ CallbackFilter å®žçŽ°å¯¹è±¡è·¯ç”±ç­–ç•¥: 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859import net.sf.cglib.proxy.Callback;import net.sf.cglib.proxy.Dispatcher;import net.sf.cglib.proxy.Enhancer;/** * Dispatcher ä»£ç†é€»è¾‘ */public class CglibDispatcher &#123; public static void main(String... args) &#123; Object[] business = new Object[]&#123;(Eat) () -&gt; "eat", (Drink) () -&gt; "drink"&#125;; Object person = createPerson(business); System.out.println(((Eat) person).eat()); System.out.println(((Drink) person).drink()); business[0] = (Eat) () -&gt; "Eat"; System.out.println(((Eat) person).eat()); &#125; /** * åˆ›å»ºä»£ç†å¯¹è±¡ */ public static Object createPerson(Object[] business) &#123; Enhancer enhancer = new Enhancer(); enhancer.setInterfaces(new Class[]&#123;Eat.class, Drink.class&#125;); // è®¾ç½®ä»£ç†æŽ¥å£ enhancer.setCallbackFilter( method -&gt; method.getName().equals("eat") ? 0 : 1); // è®¾ç½®åˆ†å‘è·¯ç”±è§„åˆ™ enhancer.setCallbacks(new Callback[]&#123; (Dispatcher) () -&gt; &#123; System.out.println("set callback0"); return business[0]; &#125;, (Dispatcher) () -&gt; &#123; System.out.println("set callback1"); return business[1]; &#125;&#125;); // è®¾ç½®è°ƒåº¦å¯¹è±¡ return enhancer.create(); &#125; /** * ä¸šåŠ¡ç±»å®šä¹‰ * * è¿™é‡Œå®šä¹‰äº†ä¸¤ä¸ªä¸šåŠ¡ç±»åž‹ */ interface Eat &#123; String eat(); &#125; interface Drink &#123; String drink(); &#125;&#125; è®©æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¾“å‡º: 123456set callback0eatset callback1drinkset callback0Eat æ ¹æ®æˆ‘ä»¬åœ¨ enhancer.setCallbackFilter é‡Œé¢å®šä¹‰çš„ä»£ç†è·¯ç”±é€»è¾‘ï¼Œè¢«è°ƒçš„æ–¹æ³•åç§°å†³å®šäº†è·¯ç”±å¯¹è±¡ã€‚æ ¹æ®è¾“å‡ºç»“æžœä¸éš¾æŽ¨æ–­ï¼šå½“ä»£ç†å¯¹è±¡æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå¯¹åº”ç›®æ ‡å¯¹è±¡çš„è£…è½½æ–¹æ³•ä¹Ÿå°†è¢«æ‰§è¡Œã€‚å› æ­¤å¯ä»¥ä¿è¯ç›®æ ‡å¯¹è±¡æ›´æ–°æ—¶ï¼Œè£…è½½å¯¹è±¡æ— éœ€æ›´æ–°ã€‚ ProxyRefDispatcher ä»£ç†é€»è¾‘è°ƒç”¨å™¨ ProxyRefDispatcher ä¹Ÿæ˜¯ä¸€ä¸ªä»£ç†åˆ†å‘å™¨ï¼Œå…¶å®žçŽ°é€»è¾‘å’Œç‰¹æ€§åŸºæœ¬ä¸Ž Dispatcher ä¸€è‡´ã€‚å”¯ä¸€çš„åŒºåˆ«åœ¨äºŽå…¶è£…è½½æ–¹æ³•ä¸­ä¼ é€’äº†ä¸€ä¸ªå½“å‰ä»£ç†å¯¹è±¡çš„å¼•ç”¨ proxy: 12345678910111213141516package net.sf.cglib.proxy;/** * Dispatching &#123;@link Enhancer&#125; callback. This is the same as the * &#123;@link Dispatcher&#125; except for the addition of an argument * which references the proxy object. */public interface ProxyRefDispatcher extends Callback &#123; /** * Return the object which the original method invocation should * be dispatched. This method is called for &lt;b&gt;every&lt;/b&gt; method invocation. * @param proxy a reference to the proxy (generated) object * @return an object that can invoke the method */ Object loadObject(Object proxy) throws Exception;&#125; æž„å»ºå’Œ Dispatcher ç›¸ä¼¼çš„æ ·ä¾‹ä»£ç å¦‚ä¸‹: 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859import net.sf.cglib.proxy.Callback;import net.sf.cglib.proxy.Enhancer;import net.sf.cglib.proxy.ProxyRefDispatcher;/** * Dispatcher ä»£ç†é€»è¾‘ */public class CglibDispatcher &#123; public static void main(String... args) &#123; Object[] business = new Object[]&#123;(Eat) () -&gt; "eat", (Drink) () -&gt; "drink"&#125;; Object person = createPerson(business); System.out.println(((Eat) person).eat()); System.out.println(((Drink) person).drink()); business[0] = (Eat) () -&gt; "Eat"; System.out.println(((Eat) person).eat()); &#125; /** * åˆ›å»ºä»£ç†å¯¹è±¡ */ public static Object createPerson(Object[] business) &#123; Enhancer enhancer = new Enhancer(); enhancer.setInterfaces(new Class[]&#123;Eat.class, Drink.class&#125;); // è®¾ç½®ä»£ç†æŽ¥å£ enhancer.setCallbackFilter( method -&gt; method.getName().equals("eat") ? 0 : 1); // è®¾ç½®åˆ†å‘è·¯ç”±è§„åˆ™ enhancer.setCallbacks(new Callback[]&#123; (ProxyRefDispatcher) (p) -&gt; &#123; System.out.println("set callback0"); return business[0]; &#125;, (ProxyRefDispatcher) (p) -&gt; &#123; System.out.println("set callback1"); return business[1]; &#125;&#125;); // è®¾ç½®è°ƒåº¦å¯¹è±¡ return enhancer.create(); &#125; /** * ä¸šåŠ¡ç±»å®šä¹‰ * * è¿™é‡Œå®šä¹‰äº†ä¸¤ä¸ªä¸šåŠ¡ç±»åž‹ */ interface Eat &#123; String eat(); &#125; interface Drink &#123; String drink(); &#125;&#125; å…¶è¿è¡Œç»“æžœä¸Ž Dispatcher æ ·ä¾‹ä¸€è‡´: 123456set callback0eatset callback1drinkset callback0Eat ç”±æ­¤å¯è§å®ƒä»¬çš„åŒºåˆ«ä»…åœ¨äºŽç›®æ ‡å¯¹è±¡è£…è½½ä¸Šï¼ŒProxyRefDispatcher å¯ä»¥åœ¨è£…è½½æ—¶æ›´æ–¹ä¾¿åœ°ä½¿ç”¨ä»£ç†å¯¹è±¡çš„ä¿¡æ¯ã€‚ NoOp ä»£ç†é€»è¾‘è°ƒç”¨å™¨ NoOp ä»£ç†é€»è¾‘è°ƒç”¨å™¨æ­£å¦‚å…¶åå­—æ‰€å®šä¹‰ï¼Œè‹¥ä¸€ä¸ªæ–¹æ³•ä½¿ç”¨è¯¥è°ƒç”¨å™¨ï¼Œä»£ç†å¯¹è±¡å°†ç›´æŽ¥è°ƒç”¨è¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œä¸è¿›è¡Œä»»ä½•é€»è¾‘åˆ‡å…¥ã€‚å¯èƒ½æœ‰äººä¼šç–‘æƒ‘ä»€ä¹ˆåœºæ™¯ä¼šä½¿ç”¨ä¸€ä¸ªä¸åˆ‡å…¥ä»£ç†é€»è¾‘çš„ä»£ç†è°ƒç”¨ï¼Ÿç¡®å®žå¦‚æ­¤ï¼ŒNoOp ä¸€èˆ¬ä¸ä¼šå•ç‹¬ä½¿ç”¨ï¼Œå®ƒå¾€å¾€é…åˆå…¶ä»–è°ƒç”¨å™¨å®žçŽ°å¤æ‚çš„æ–¹æ³•ä»£ç†åŠŸèƒ½ï¼Œè¯·è§å¦‚ä¸‹æ ·ä¾‹: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364import net.sf.cglib.proxy.CallbackHelper;import net.sf.cglib.proxy.Enhancer;import net.sf.cglib.proxy.MethodInterceptor;import net.sf.cglib.proxy.NoOp;import java.lang.reflect.Method;/** * NoOp ä»£ç†é€»è¾‘è°ƒç”¨å™¨ */public class CglibNoOp &#123; public static void main(String... args) &#123; Business business = createProxy(Business.class); System.out.println("å¼€å§‹è°ƒç”¨éžä¸šåŠ¡æ–¹æ³•"); business.sayHello(); System.out.println("å¼€å§‹è°ƒç”¨ä¸šåŠ¡æ–¹æ³•"); business.doBusiness(); &#125; public static Business createProxy(Class proxyCls) &#123; CallbackHelper callbackHelper = new CallbackHelper(proxyCls, new Class[0]) &#123; @Override protected Object getCallback(Method method) &#123; /** * æ ¹æ®æ–¹æ³•åç§°åˆ¤æ–­ä¸šåŠ¡æ–¹æ³• * * 1. å¯¹äºŽä¸šåŠ¡æ–¹æ³•åˆ‡å…¥ä»£ç†é€»è¾‘ * * 2. å¯¹äºŽå…¶ä»–æ–¹æ³•, ä¸è¿›è¡Œä»£ç†æ“ä½œ*/ if (method.getName().contains("Business")) &#123; return (MethodInterceptor) (obj, method1, args, proxy) -&gt; &#123; System.out.println("do proxy logical"); return proxy.invokeSuper(obj, args); &#125;; &#125; else &#123; return NoOp.INSTANCE; &#125; &#125; &#125;; Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(proxyCls); enhancer.setCallbackFilter(callbackHelper); enhancer.setCallbacks(callbackHelper.getCallbacks()); return (Business) enhancer.create(); &#125; private static class Business &#123; public Business() &#123; &#125; public void sayHello() &#123; System.out.println("hello world"); &#125; public void doBusiness() &#123; System.out.println("do business"); &#125; &#125;&#125; è¯¥æ ·ä¾‹è¾“å‡ºç»“æžœå¦‚ä¸‹: 12345å¼€å§‹è°ƒç”¨éžä¸šåŠ¡æ–¹æ³•hello worldå¼€å§‹è°ƒç”¨ä¸šåŠ¡æ–¹æ³•do proxy logicaldo business å“ˆå“ˆ~ çœ‹æ˜Žç™½äº†å—ï¼Ÿè¿™é‡Œæ–°å¼•å…¥äº†ä¸€ä¸ª CallBackHelper ç±»åž‹å¯¹è±¡ï¼Œå®ƒçš„ getCallback() æ–¹æ³•å°†æ ¹æ®è¢«è°ƒæ–¹æ³•ä¿¡æ¯é€‰æ‹©åˆé€‚çš„ CallBack å®žä¾‹ã€‚æ˜¯çš„ï¼Œå¯¹äºŽä¸€ä¸ªç±»æ¥è¯´ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„æ–¹æ³•éƒ½éœ€è¦å­˜åœ¨ä»£ç†é€»è¾‘ï¼Œå¦‚Object.clone()æ–¹æ³•ï¼Œæ­¤æ—¶ä½¿ç”¨ NoOp.INSTANCE å¯¹è±¡å°±å†åˆé€‚ä¸è¿‡äº† ^ ^ã€‚ å‹æƒ…æç¤º æ ·ä¾‹ä¸­å¤§é‡ä½¿ç”¨äº†éžé™æ€åŒ¿åç±»çš„å£°æ˜Žæ–¹å¼ï¼Œè¯¥æ–¹å¼ä¼šåœ¨å†…éƒ¨ç±»å¯¹è±¡ä¸­éšå¼ç”Ÿæˆä¸€ä¸ªå¤–éƒ¨ç±»å¯¹è±¡çš„å¼•ç”¨ã€‚è€Œå†…éƒ¨ç±»å¯¹è±¡å¾€å¾€éš¾ä»¥ç›´æŽ¥å¼•ç”¨ï¼Œå½“å†…éƒ¨ç±»å¯¹è±¡ä¸èƒ½é‡Šæ”¾æ—¶ï¼Œå¤–éƒ¨ç±»å¯¹è±¡ä¹Ÿå°†æ— æ³•é‡Šæ”¾ï¼Œå®¹æ˜“å¼•å‘ javaå†…å­˜å†™æ¼ã€‚æ ·ä¾‹ä¸­çš„ä½¿ç”¨æ–¹å¼å®Œå…¨åœ¨äºŽç¼©å‡ä»£ç é‡è€ƒè™‘ï¼Œç”Ÿäº§çŽ¯å¢ƒä¸­å¯ä½¿ç”¨é™æ€å†…éƒ¨ç±»ä»£æ›¿ã€‚ ä¸‰ã€CGLIB åŠ¨æ€ä»£ç†ç‰¹ç‚¹å½’çº³å’Œæ€»ç»“ç®€å•åˆ—ä¸€ä¸‹ CGLIB ä»£ç†çš„ç‰¹ç‚¹ä½œä¸ºå‚è€ƒå§: CGLIB çš„ä»£ç†å®žçŽ°éœ€è¦ä¾èµ–ç¬¬ä¸‰æ–¹åº“; CGLIB æ”¯æŒç±»çº§åˆ«çš„ä»£ç†(ç›¸å¯¹äºŽ JDK åŠ¨æ€ä»£ç† æ›´ä¸ºæ–¹ä¾¿); CGLIB åªæ”¯æŒå¯¹ éžstaticä¸”éžfinalçš„publicæ–¹æ³• è¿›è¡Œä»£ç†; CGLIB æ”¯æŒå¤šç§ä»£ç†é€»è¾‘è°ƒç”¨å™¨ï¼Œå¯ä»¥å®žçŽ°ä¸°å¯Œçš„ä»£ç†ï¼Œåˆ†å‘åŠŸèƒ½ï¼ˆåŽç»­ä¼šåšæ›´è¯¦ç»†ä»‹ç»ï¼‰; ä¸ªäººè®¤ä¸º CGLIB ä»£ç†å®žçŽ°ä¸Šæ›´ç›´è§‚ç®€æ´; ä¸éš¾å‘çŽ° CGLIB çš„ ä»£ç†é€»è¾‘ å’Œ ä»£ç†è£…é…é€»è¾‘ ä¹Ÿç›¸äº’éš”ç¦»ï¼Œè€Œè£…é…é€»è¾‘å¯èƒ½åœ¨è¿è¡Œæ—¶æ‰ç¡®å®šã€‚å› æ­¤ CGLIB å’Œ JDKåŽŸç”ŸåŠ¨æ€ä»£ç† ä¸€æ ·ä¹Ÿæ˜¯è¿è¡Œæ—¶å®žçŽ°ä»£ç†ç”Ÿæˆçš„ã€‚ä½†ç›¸è¾ƒè€Œè¨€ï¼Œä½¿ç”¨ CGLIB å®žçŽ°åŠ¨æ€ä»£ç†ä¼šæ›´æ–¹ä¾¿ï¼Œæ›´å®‰å…¨ã€‚ æƒ³è¦æ›´æ·±åº¦äº†è§£ CGLIB çš„å°ä¼™ä¼´å¯ä»¥é˜…è¯»å®˜æ–¹tutorial,å¿…é¡»è®©ä½ å—ç›Šæ— ç©·ã€‚ ^ ^]]></content>
    </entry>

    
    <entry>
      <title><![CDATA[JDK åŠ¨æ€ä»£ç†æœºåˆ¶]]></title>
      <url>%2F2017%2F02%2F06%2FJDK-proxy%2F</url>
      <content type="text"><![CDATA[ç®€è¿°JDK åŠ¨æ€ä»£ç†æ˜¯ä¸€ç§åŸºäºŽåå°„çš„è¿è¡Œæ—¶é€»è¾‘åˆ‡å…¥ã€‚å®žçŽ°ç®€å•ï¼Œä½†åªä½œç”¨äºŽæŽ¥å£çº§åˆ«ã€‚ä»¥ä¸‹ç¤ºä¾‹å°†ä¸€æ­¥æ­¥æ¼”ç¤ºå…¶å®žçŽ°è¿‡ç¨‹å¹¶åˆ†æžå…¶å®žçŽ°ç‰¹ç‚¹åŠåº”ç”¨åœºæ™¯ã€‚ ä¸€ã€java åŠ¨æ€ä»£ç†å®žçŽ°ç®€è¿°- UML ç±»å›¾æè¿°: ç±»å›¾åˆ†æž: ä»Žç±»å›¾å…³ç³»å¯ä»¥çœ‹å‡ºï¼Œä»£ç†é€»è¾‘(ProxyHandler)å’Œä¸šåŠ¡é€»è¾‘(BusinessImpl)åœ¨å®šä¹‰æ—¶æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚ ä»£ç†å¯¹è±¡æ˜¯ç”±Proxy.newProxyInstance() æ–¹æ³•ç”Ÿæˆ, è¯¥æ–¹æ³•å¼ºä¾èµ–äºŽ ä»£ç†é€»è¾‘å®žä¾‹(InvocationHandlerå®žä¾‹å¯¹è±¡) å’Œ è¢«ä»£ç†ä¸šåŠ¡æŽ¥å£(IBusiness)ã€‚ ç±»å›¾æ€»ç»“: é€šè¿‡åˆ†æžæˆ‘ä»¬å¯ä»¥å¾—å‡ºä»£ç†å¯¹è±¡çš„åˆ›å»ºå¿…é¡»ä¾èµ–å…·ä½“ä»£ç†é€»è¾‘çš„å®šä¹‰å’Œè¢«ä»£ç†æŽ¥å£çš„å®šä¹‰ã€‚åˆ›å»ºä»£ç†çš„è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥: å®šä¹‰å¹¶æ˜Žç¡®éœ€è¦è¢«ä»£ç†çš„ä¸šåŠ¡æŽ¥å£; å®žçŽ° InvocationHandler æŽ¥å£ï¼Œåˆ›å»ºä»£ç†é€»è¾‘å®žä¾‹ç±»; é€šè¿‡ Proxy.newProxyInstance() æ–¹æ³•åˆ›å»ºå…·ä½“ä»£ç†å¯¹è±¡ éœ€è¦æ³¨æ„çš„æ˜¯ InvocationHandler å®žä¾‹ç±»ä¹Ÿä¾èµ–å…·ä½“çš„ä¸šåŠ¡å¯¹è±¡ï¼Œå› ä¸ºåœ¨ä»£ç†è¿›è¡Œæ–¹æ³•è°ƒç”¨æ—¶å¿…é¡»æ˜Žç¡®è‡ªå·±ä»£ç†çš„ç›®æ ‡å¯¹è±¡æ˜¯ä»€ä¹ˆã€‚ äºŒã€JDK åŠ¨æ€ä»£ç†æ ·ä¾‹å®žçŽ°- å®šä¹‰ä¸šåŠ¡æŽ¥å£å’Œä¸šåŠ¡å®žçŽ°ç±»ä¸šåŠ¡æŽ¥å£å’Œå®žçŽ°ç±»å®Œå…¨æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿›è¡Œå®šä¹‰å’Œå®žçŽ°ï¼Œè¿™é‡Œåªåšç®€å• demo æ¼”ç¤ºï¼Œæ•…åªæ˜¯å®žçŽ°äº†ä¸€ä¸ªç®€ä»‹çš„ doBusiness æ–¹æ³•: ä¸šåŠ¡æŽ¥å£: 123456789101112131415/** * ä¸šåŠ¡æŽ¥å£ */public interface IBusiness &#123; /** * ä¸šåŠ¡æ–¹æ³• * * @param business ä¸šåŠ¡å‚æ•° * @return æ‰§è¡ŒæˆåŠŸè¿”å›ž true, å¤±è´¥è¿”å›ž false * @throws IllegalArgumentException å‚æ•°å¼‚å¸¸æ—¶æŠ›å‡º */ public Boolean doBusiness(String business) throws IllegalArgumentException;&#125; ä¸šåŠ¡å®žä¾‹ç±»: 1234567891011121314151617181920212223import org.apache.commons.lang3.Validate;/** * ä¸šåŠ¡ç»†èŠ‚å®žçŽ°ç±» */public class BusinessImpl implements IBusiness &#123; /** * ä¸šåŠ¡æ–¹æ³• * * @param business ä¸šåŠ¡å‚æ•° * @return æ‰§è¡ŒæˆåŠŸè¿”å›ž true, å¤±è´¥è¿”å›ž false * @throws IllegalArgumentException å‚æ•°å¼‚å¸¸æ—¶æŠ›å‡º */ public Boolean doBusiness( String business) throws IllegalArgumentException &#123; Validate.notBlank(business); // å‚æ•°æ ¡éªŒ System.out.println("Do business: " + business); // ä¸šåŠ¡é€»è¾‘ return true; // ä¸šåŠ¡è¿”å›ž &#125;&#125; - ä»£ç†é€»è¾‘å®šä¹‰(InvocationHandlerå®žçŽ°)ä»£ç†é€»è¾‘åŒºåˆ«äºŽæ™®é€šä¸šåŠ¡é€»è¾‘ï¼Œä»–å¯ä»¥æ˜¯åŸºäºŽæ¡†æž¶åŠŸèƒ½çš„æŠ½è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯æ›´æ³›åŒ–çš„ä¸šåŠ¡é€»è¾‘æŠ½è±¡ï¼Œä½†æ˜¯ä»–çš„åŠŸèƒ½åº”è¯¥æ˜¯æ˜Žç¡®çš„: ä»£ç†çš„å­˜åœ¨ä¸€æ–¹é¢è®©å…·ä½“ä¸šåŠ¡å®žä¾‹åœ¨è¿›è¡Œä¸šåŠ¡æ“ä½œæ—¶æ›´åŠ çº¯ç²¹(å¹²å‡€), å¦å¤–ä¹Ÿä½¿æŠ½è±¡é€»è¾‘çš„ç®¡ç†æ›´åŠ ç»Ÿä¸€ã€‚ å¸¸è§çš„ä»£ç†é€»è¾‘å¦‚: è°ƒç”¨æ—¥å¿—è®°å½•ï¼Œç›‘æŽ§æ‰“ç‚¹ï¼Œä¼šè¯ç®¡ç†ï¼Œèµ„æºå›žæ”¶ ç­‰ã€‚è¿™é‡Œæˆ‘ä»¬åªåšç®€å•çš„æ‰“å°å®žçŽ°ï¼ˆä¸»è¦æ˜¯æ–¹ä¾¿è§‚å¯Ÿæ•ˆæžœ ^^ï¼‰: 12345678910111213141516171819202122232425262728293031323334353637383940414243import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;/** * ä»£ç†æ“ä½œç±» * * å…¶ä½œç”¨æ˜¯å®šä¹‰å…·ä½“çš„ä»£ç†é€»è¾‘ */public class ProxyHandler implements InvocationHandler &#123; private Object businessObject; /** * è¯¥æ¡ˆä¾‹é€šè¿‡æž„é€ å‡½æ•°è®¾ç½®è¢«ä»£ç†å¯¹è±¡(å¯é€‰) */ public ProxyHandler(Object businessObject) &#123; this.businessObject = businessObject; &#125; /** * å…·ä½“ä»£ç†é€»è¾‘åˆ‡å…¥å®žçŽ° * * å¯ä»¥å®žçŽ°çš„åŠŸèƒ½: * * 1. é€»è¾‘ç»‡å…¥(è°ƒç”¨å‰åŽå¢žåŠ éžä¸šåŠ¡é€»è¾‘) * * 2. æŽ§åˆ¶è°ƒç”¨å§¿åŠ¿(æ ¹æ®ä¸Šä¸‹æ–‡æ–¹æ³•æŽ§åˆ¶è°ƒç”¨æ–¹å¼) * * 3. è¿”å›žå€¼å’Œå¼‚å¸¸æŽ§åˆ¶ * * @param proxy ä»£ç†å¯¹è±¡ * @param method è¢«è°ƒç”¨çš„ä¸šåŠ¡æŽ¥å£æ–¹æ³• * @param args è¢«è°ƒç”¨ä¸šåŠ¡æŽ¥å£æ–¹æ³•çš„å‚æ•° */ @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; System.out.println("Do something before method"); Object result = businessObject == null ? null : method.invoke(businessObject, args); System.out.println("Do something after method"); return result; &#125;&#125; å¯ä»¥çœ‹å‡ºä»£ç†é€»è¾‘çš„å®žçŽ°è¿˜æ˜¯æ¯”è¾ƒç®€å•æ¸…æ™°çš„ï¼Œè¿™é‡Œåšäº†è¢«è°ƒæ–¹æ³•åœ¨è°ƒç”¨å‰åŽçš„æ“ä½œ(æ‰“å°)ï¼Œæ–¹æ³•è°ƒç”¨æ—¶çš„åˆ¤æ–­æ“ä½œä»¥åŠè¿”å›žå€¼çš„ä¼ é€’æ“ä½œã€‚ä¸éš¾å‘çŽ°ä»£ç†å¯¹è°ƒç”¨çš„æŽ§åˆ¶ç›¸å½“å…¨é¢ï¼Œä»–ç›´æŽ¥å†³å®šäº†æ–¹æ³•æ˜¯å¦çœŸæ­£è°ƒç”¨ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯: å› ä¸ºåŸºäºŽåå°„çš„methodæ–¹æ³•è°ƒç”¨å¿…é¡»ä¾èµ–å…·ä½“æ‰§è¡Œå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œæ‰€ä»¥è°ƒç”¨é€»è¾‘åœ¨å®žçŽ°æ—¶ä¹Ÿéœ€è¦ä¾èµ–å…·ä½“çš„ä¸šåŠ¡å®žä¾‹ã€‚ï¼ˆæœ¬ä¾‹ä¸­åœ¨æž„é€ å‡½æ•°ä¸­å¼•å…¥å®žä¾‹å¼•ç”¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä»¥setæ–¹æ³•çš„çš„å½¢å¼ä¼ å…¥ï¼Œè¿™æ ·è¿˜å¯ä»¥è¾¾åˆ°æ„æƒ³ä¸åˆ°çš„æ•ˆæžœå“¦ ^ ^ ) - ä»£ç†å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨(Proxy.newProxyInstance())è±ªçˆ½çš„æˆ‘ç›´æŽ¥ä¸Šä»£ç : 123456789101112131415161718192021222324import java.lang.reflect.Proxy;/** * JDK åŠ¨æ€ä»£åœºæ™¯ç†æµ‹è¯• */public class ProxyTest &#123; public static void main(String... args) &#123; BusinessImpl business = new BusinessImpl(); // ä¸šåŠ¡å¯¹è±¡å®žä¾‹ ProxyHandler proxyHandler = new ProxyHandler(business); // ä»£ç†é€»è¾‘æ‰§è¡Œå™¨å¯¹è±¡ /**åˆ›å»ºä»£ç†å¯¹è±¡*/ IBusiness businessProxy = (IBusiness) Proxy.newProxyInstance( business.getClass().getClassLoader(), new Class[]&#123;IBusiness.class&#125;, proxyHandler); businessProxy.doBusiness("business"); // å¤„ç†ä¸šåŠ¡ &#125;&#125; å¯¥å¯¥å‡ è¡Œ, ä¸è¦å¤ªç®€å•ï¼ï¼ä»£ç†å¯¹è±¡çš„åˆ›å»ºåªéœ€ä¸‰ä¸ªå‚æ•°: è¢«ä»£ç†å¯¹è±¡çš„ç±»åŠ è½½å™¨; è¢«ä»£ç†çš„æŽ¥å£åˆ—è¡¨; åˆšåˆšå®šä¹‰çš„ä»£ç†é€»è¾‘å®žä¾‹å¯¹è±¡; æŽ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹æ‰§è¡Œæ•ˆæžœ: 123Do something before methodDo business: businessDo something after method å“ˆå“ˆ~ ä»£ç†é€»è¾‘å·²ç»å®Œç¾Žæ‰§è¡Œ! ä¸‰ã€JDK åŠ¨æ€ä»£ç†ç‰¹æ€§åˆ†æžä¸Šé¢å·²ç»è¯´è¿‡ï¼Œä»£ç†çš„å­˜åœ¨ä¸€æ–¹é¢è®©å…·ä½“ä¸šåŠ¡å®žä¾‹åœ¨è¿›è¡Œä¸šåŠ¡æ“ä½œæ—¶æ›´åŠ çº¯ç²¹(å¹²å‡€), å¦å¤–ä¹Ÿä½¿æŠ½è±¡é€»è¾‘çš„ç®¡ç†æ›´åŠ ç»Ÿä¸€ã€‚éœ€è¦æŒ‡å‡ºçš„æ˜¯ JDK åŠ¨æ€ä»£ç† åªæ˜¯ä¼—å¤šä»£ç†å®žçŽ°æ–¹å¼ä¸­çš„ä¸€ç§ï¼Œå¦‚åœ¨springæ¡†æž¶ä¸­ï¼Œå…¶AOPå®žçŽ°å°±ç»¼åˆäº† JDK åŠ¨æ€ä»£ç† å’Œ CGLIB ä»£ç† ã€‚æŽ¥ä¸‹æ¥è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ JDK åŠ¨æ€ä»£ç† çš„ç‰¹ç‚¹: JDK åŽŸç”Ÿæ”¯æŒï¼Œæ— éœ€ä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼› JDK åŠ¨æ€ä»£ç† å®žè´¨ä¸Šä¸ºè¿è¡Œæ—¶é€šè¿‡ä»£ç†å¯¹è±¡é—´æŽ¥è°ƒç”¨ç›®æ ‡å¯¹è±¡æ–¹æ³•è¾¾åˆ°é€»è¾‘åˆ‡å…¥ç›®çš„ï¼ˆå¹¶ä¸ä¿®æ”¹åŽŸæœ‰ä¸šåŠ¡é€»è¾‘ï¼‰ ä¾èµ–ä¸šåŠ¡æŽ¥å£ã€‚ä»£ç†å¯¹è±¡åœ¨ç”Ÿæˆæ—¶å¼ºä¾èµ–äºŽè¢«ä»£ç†çš„ä¸šåŠ¡æŽ¥å£ï¼Œå› æ­¤åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå¢žåŠ ä¸å¿…è¦çš„æŽ¥å£å®šä¹‰ï¼ˆä¸æ”¯æŒæ–¹æ³•ç²’åº¦ä»£ç†ï¼‰ã€‚ ä»£ç†é€»è¾‘å®žçŽ°æ–¹ä¾¿ï¼Œä½†ä¹Ÿè¿‡äºŽç®€é™‹ã€‚å¯¹äºŽè¢«ä»£ç†å¯¹è±¡ï¼Œä»–çš„æ‰€æœ‰æ–¹æ³•åœ¨è°ƒç”¨æ—¶éƒ½ä¼šæ‰§è¡Œä»£ç†é€»è¾‘ç±»ä¸­çš„invokeæ–¹æ³•ï¼Œè¿™ä¹Ÿè¯´æ˜Žåœ¨å”¯ä¸€çš„ä¸€ä¸ªinvokeæ–¹æ³•ä¸­å¿…é¡»coverç›®æ ‡å¯¹è±¡ä¸­æ‰€æœ‰æ–¹æ³•çš„æ‰§è¡Œé€»è¾‘ã€‚å¾ˆæ˜¾ç„¶ï¼Œå½“æŽ¥å£ä¸­å­˜åœ¨ä»£ç†é€»è¾‘ä¸ä¸€è‡´çš„æ–¹æ³•æ—¶ï¼Œè¿™ç§æ–¹å¼å¾ˆå®¹æ˜“é€ æˆä¸å¿…è¦çš„è€¦åˆï¼Œä¸ä¾¿äºŽä»£ç†é€»è¾‘å¼€å‘ç»´æŠ¤ï¼ˆä»£ç†é€»è¾‘å®šä¹‰æ—¶å®¹æ˜“è€¦åˆï¼‰ã€‚ å››ã€æ€»ç»“ ä»£ç†çš„åº”ç”¨åœ¨æ¡†æž¶ç±»åž‹çš„é¡¹ç›®å¼€å‘ä¸­æ˜¯å¾ˆå¸¸è§çš„ï¼Œå…¶é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚æœ¬ç¯‡ç®€å•ä»‹ç»äº†åŽŸç”Ÿçš„JDK åŠ¨æ€ä»£ç†ï¼Œå…¶å®žçŽ°ç®€å•ï¼Œé€»è¾‘æ¸…æ™°ã€‚å¯ä»¥çœ‹å‡ºåœ¨æ™®é€šé¢å‘æŽ¥å£ï¼Œåˆ‡å…¥é€»è¾‘ç®€å•ä¸”ç»Ÿä¸€çš„ä»£ç†å®žçŽ°ä¸Šï¼ŒJDK åŠ¨æ€ä»£ç†æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œä½†æ˜¯é¢å¯¹æ›´ç»†è‡´çš„ä»£ç†åœºæ™¯ï¼Œå¦‚è·¨æŽ¥å£çš„æ–¹æ³•çº§åˆ«ä»£ç†éœ€æ±‚ï¼ŒJDK åŠ¨æ€ä»£ç†ä¾¿æ˜¾å¾—ä½™åŠ›ä¸è¶³äº†ã€‚åŽé¢çš„åšæ–‡ä¸­å‘å¤§å®¶ä»‹ç»ä¸€ä¸ªæ–¹æ³•çº§åˆ«çš„ä»£ç†åº“â€”-CGLIB,å®ƒä¹Ÿæ˜¯ spring AOP ä»£ç†å®žçŽ°ä¸­çš„é‡è¦ä¸€å‘˜ã€‚]]></content>
    </entry>

    
    <entry>
      <title><![CDATA[spring AOP APIs ç®€è¿°]]></title>
      <url>%2F2017%2F02%2F04%2Fspring-AOP-APIs%2F</url>
      <content type="text"><![CDATA[1. Pointcut API1.1 æŽ¥å£å®šä¹‰: spring pointcut ç”¨äºŽå°† advices æŒ‡å‘ç‰¹å®šçš„ç±»å’Œæ–¹æ³•ã€‚å…¶å…·ä½“å®šä¹‰å¦‚ä¸‹: 12345678910111213141516171819202122232425262728293031323334353637package org.springframework.aop;/** * Core Spring pointcut abstraction. * * &lt;p&gt;A pointcut is composed of a &#123;@link ClassFilter&#125; and a &#123;@link MethodMatcher&#125;. * Both these basic terms and a Pointcut itself can be combined to build up combinations * (e.g. through &#123;@link org.springframework.aop.support.ComposablePointcut&#125;). * * @author Rod Johnson * @see ClassFilter * @see MethodMatcher * @see org.springframework.aop.support.Pointcuts * @see org.springframework.aop.support.ClassFilters * @see org.springframework.aop.support.MethodMatchers */public interface Pointcut &#123; /** * Return the ClassFilter for this pointcut. * @return the ClassFilter (never &#123;@code null&#125;) */ ClassFilter getClassFilter(); /** * Return the MethodMatcher for this pointcut. * @return the MethodMatcher (never &#123;@code null&#125;) */ MethodMatcher getMethodMatcher(); /** * Canonical Pointcut instance that always matches. */ Pointcut TRUE = TruePointcut.INSTANCE;&#125; å¯ä»¥çœ‹å‡º pointcut æŽ¥å£åˆ†æˆ `ç±»åž‹åŒ¹é…` å’Œ `æ–¹æ³•åŒ¹é…` ä¸¤ä¸ªéƒ¨åˆ†, å®ƒä»¬å…±åŒå®žçŽ°äº†åˆ‡ç‚¹çš„è¯†åˆ«; ClassFilter æŽ¥å£: ClassFilter ç”¨æ¥æŒ‡å®šéœ€è¦åˆ‡å…¥çš„ç›®æ ‡ç±»åž‹ã€‚å…¶æŽ¥å£å®šä¹‰å¦‚ä¸‹: 123456789101112131415161718192021222324252627282930313233343536373839404142434445 /* * Copyright 2002-2007 the original author or authors. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */package org.springframework.aop;/** * Filter that restricts matching of a pointcut or introduction to * a given set of target classes. * * &lt;p&gt;Can be used as part of a &#123;@link Pointcut&#125; or for the entire * targeting of an &#123;@link IntroductionAdvisor&#125;. * * @author Rod Johnson * @see Pointcut * @see MethodMatcher */public interface ClassFilter &#123; /** * Should the pointcut apply to the given interface or target class? * @param clazz the candidate target class * @return whether the advice should apply to the given target class */ boolean matches(Class&lt;?&gt; clazz); /** * Canonical instance of a ClassFilter that matches all classes. */ ClassFilter TRUE = TrueClassFilter.INSTANCE;&#125; å¦‚æžœ matches æ–¹æ³•è¿”å›ž `true` åˆ™å¯¹åº”çš„ç±»å°†è¢«é€‰ä¸­ä¸ºé€šçŸ¥ç±»åž‹; MethodMatcher æŽ¥å£: MethodMatcher æŽ¥å£æ˜¯ä¸€ä¸ªæ›´ä¸ºé‡è¦çš„æŽ¥å£, å…¶å…·ä½“å®žçŽ°å¦‚ä¸‹: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697 /* * Copyright 2002-2012 the original author or authors. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */package org.springframework.aop;import java.lang.reflect.Method;/** * Part of a &#123;@link Pointcut&#125;: Checks whether the target method is eligible for advice. * * &lt;p&gt;A MethodMatcher may be evaluated &lt;b&gt;statically&lt;/b&gt; or at &lt;b&gt;runtime&lt;/b&gt; (dynamically). * Static matching involves method and (possibly) method attributes. Dynamic matching * also makes arguments for a particular call available, and any effects of running * previous advice applying to the joinpoint. * * &lt;p&gt;If an implementation returns &#123;@code false&#125; from its &#123;@link #isRuntime()&#125; * method, evaluation can be performed statically, and the result will be the same * for all invocations of this method, whatever their arguments. This means that * if the &#123;@link #isRuntime()&#125; method returns &#123;@code false&#125;, the 3-arg * &#123;@link #matches(java.lang.reflect.Method, Class, Object[])&#125; method will never be invoked. * * &lt;p&gt;If an implementation returns &#123;@code true&#125; from its 2-arg * &#123;@link #matches(java.lang.reflect.Method, Class)&#125; method and its &#123;@link #isRuntime()&#125; method * returns &#123;@code true&#125;, the 3-arg &#123;@link #matches(java.lang.reflect.Method, Class, Object[])&#125; * method will be invoked &lt;i&gt;immediately before each potential execution of the related advice&lt;/i&gt;, * to decide whether the advice should run. All previous advice, such as earlier interceptors * in an interceptor chain, will have run, so any state changes they have produced in * parameters or ThreadLocal state will be available at the time of evaluation. * * @author Rod Johnson * @since 11.11.2003 * @see Pointcut * @see ClassFilter */public interface MethodMatcher &#123; /** * Perform static checking whether the given method matches. If this * returns &#123;@code false&#125; or if the &#123;@link #isRuntime()&#125; method * returns &#123;@code false&#125;, no runtime check (i.e. no. * &#123;@link #matches(java.lang.reflect.Method, Class, Object[])&#125; call) will be made. * @param method the candidate method * @param targetClass the target class (may be &#123;@code null&#125;, in which case * the candidate class must be taken to be the method's declaring class) * @return whether or not this method matches statically */ boolean matches(Method method, Class&lt;?&gt; targetClass); /** * Is this MethodMatcher dynamic, that is, must a final call be made on the * &#123;@link #matches(java.lang.reflect.Method, Class, Object[])&#125; method at * runtime even if the 2-arg matches method returns &#123;@code true&#125;? * &lt;p&gt;Can be invoked when an AOP proxy is created, and need not be invoked * again before each method invocation, * @return whether or not a runtime match via the 3-arg * &#123;@link #matches(java.lang.reflect.Method, Class, Object[])&#125; method * is required if static matching passed */ boolean isRuntime(); /** * Check whether there a runtime (dynamic) match for this method, * which must have matched statically. * &lt;p&gt;This method is invoked only if the 2-arg matches method returns * &#123;@code true&#125; for the given method and target class, and if the * &#123;@link #isRuntime()&#125; method returns &#123;@code true&#125;. Invoked * immediately before potential running of the advice, after any * advice earlier in the advice chain has run. * @param method the candidate method * @param targetClass the target class (may be &#123;@code null&#125;, in which case * the candidate class must be taken to be the method's declaring class) * @param args arguments to the method * @return whether there's a runtime match * @see MethodMatcher#matches(Method, Class) */ boolean matches(Method method, Class&lt;?&gt; targetClass, Object[] args); /** * Canonical instance that matches all methods. */ MethodMatcher TRUE = TrueMethodMatcher.INSTANCE;&#125; å½“åˆ›å»º proxy å¯¹è±¡æ—¶ï¼Œ `matches(Method method, Class&lt;?&gt; targetClass);`æ–¹æ³•å°†è¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•ç”¨äºŽåˆ¤æ–­å½“å‰ç±»çš„æ–¹æ³•æ˜¯å¦ä¸ºåˆ‡å…¥ç‚¹ï¼Œ è¿™ä¸ªæ–¹æ³•ä¸ä¼šåœ¨ç›®æ ‡å¯¹è±¡è¢«è°ƒç”¨æ—¶æ‰§è¡Œã€‚å½“ è¯¥æ–¹æ³•è¿”å›žtrue ä¸” isRuntime()æ–¹æ³•è¿”å›ž trueæ—¶ï¼Œæ¯æ¬¡è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„è¯¥æ–¹æ³•éƒ½ä¼šè§¦å‘ matches(Method method, Class&lt;?&gt; targetClass, Object[] args) æ–¹æ³•çš„è°ƒç”¨ï¼Œ æ­¤æ—¶ä¼šåˆ¤æ–­å‚æ•°ä¿¡æ¯æ˜¯å¦ç¬¦åˆåˆ‡å…¥ç‚¹åŒ¹é…è§„åˆ™ã€‚å¤§éƒ¨åˆ† MethodMatcher éƒ½æ˜¯é™æ€çš„ï¼Œè¿™æ„å‘³ç€ isRuntime()æ–¹æ³•éƒ½æ˜¯è¿”å›žfalse,è¿™æ ·çš„Matcherå°†ä¸ä¼šåœ¨ç›®æ ‡å¯¹è±¡è°ƒç”¨æ—¶æ£€æµ‹æ–¹æ³•æ˜¯å¦åŒ¹é…åˆ‡å…¥è§„åˆ™ã€‚ 1.2 å¯¹Pointcutçš„æ“ä½œ: spring æ”¯æŒå¯¹ Pointcut è¿›è¡Œäº¤å¹¶è¡¥æ“ä½œ: äº¤é›†æ“ä½œæ„å‘³ç€ä¸€ä¸ªæ–¹æ³•å¿…é¡»è¢«æ‰€æœ‰çš„ pointcut åŒ¹é…é€šè¿‡; å¹¶é›†æ“ä½œæ„å‘³ç€ä¸€ä¸ªæ–¹æ³•åªéœ€è¢«ä»»æ„ä¸€ä¸ª pointcut åŒ¹é…é€šè¿‡; 1.3 æ–¹ä¾¿çš„ Pointcut çŽ°æœ‰ç±»å®žçŽ°: spring æä¾›äº†ä¸€ç³»åˆ—Pointcutå®žä¾‹ç±»,ä¸€äº›å¼€ç®±å³ç”¨ï¼Œä¸€äº›éœ€è¦æ ¹æ®ç‰¹å®šçš„åº”ç”¨åœºæ™¯é›†æˆå®žçŽ°ç‰¹å®šçš„å®žä¾‹ç±»ã€‚ é™æ€ pointcut: é™æ€ pointcut ä¸åŸºäºŽæ–¹æ³•è°ƒç”¨æ—¶ä¼ å…¥å‚æ•°ä½œä¸ºåˆ‡ç‚¹åˆ¤æ–­ä¾æ®ã€‚å®ƒä»¬åªåœ¨ ä»£ç†å¯¹è±¡åˆå§‹åŒ–æ—¶å¯¹ç±»æ–¹æ³•è¿›è¡Œåˆ‡å…¥è¯„ä¼°ï¼Œå› æ­¤æ›´é«˜æ•ˆã€‚ä»¥ä¸‹æ˜¯ä¸€äº›é™æ€ pointcut çš„å®žä¾‹ç±»; åŠ¨æ€ pointcut: ç›¸å¯¹äºŽé™æ€pointcut, åŠ¨æ€pointcutåŸºäºŽè°ƒç”¨æ—¶ä¼ å…¥çš„å‚æ•°æˆ–å…¶ä»–è¿è¡Œæ—¶ä¿¡æ¯(å¦‚å †æ ˆä¿¡æ¯)è¯„ä¼°æ–¹æ³•åˆ‡å…¥ã€‚å› æ­¤åŠ¨æ€ pointcut å°†åœ¨æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶è¿›è¡Œè¯„ä¼°ï¼Œå…¶æ¶ˆè€—åž‹ç›¸å¯¹è¾ƒé«˜; 2. Advice API2.1 advice çš„ç”Ÿå‘½å‘¨æœŸ:advice å¯ä»¥åˆ†æˆ per-class å’Œ per-instance ä¸¤ç§ã€‚ per-class Advice ç”Ÿå‘½å‘¨æœŸ: è¿™ç§ç±»åž‹çš„Adviceæ˜¯æ— çŠ¶æ€çš„ï¼Œä»–åªåŸºäºŽæ–¹æ³•å’Œå‚æ•°å®žçŽ°é€šçŸ¥é€»è¾‘ï¼Œå› æ­¤å®ƒå¯ä»¥è¢«å¤šä¸ªè¢«é€šçŸ¥å¯¹è±¡å…±äº«ã€‚ per-instance Advice ç”Ÿå‘½å‘¨æœŸ: è¿™ç§ç±»åž‹çš„ Advice é€šè¿‡ç‰¹å®šçš„çŠ¶æ€ä¿¡æ¯å®žçŽ°ä¸€äº›é«˜çº§åŠŸèƒ½ï¼Œå› æ­¤å…¶ç”Ÿå‘½å‘¨æœŸå’Œå…·ä½“çš„è¢«ä»£ç†å®žä¾‹å¯¹è±¡ç›¸å¯¹åº”ã€‚ 2.2 spring ä¸­çš„ Advice:spring æä¾›äº†ä¸€ç³»åˆ—å¼€ç®±å³ç”¨çš„ Advice ç±»åž‹: interception around advice: 1234567public class DebugInterceptor implements MethodInterceptor &#123; public Object invoke( MethodInvocation invocation) throws Throwable &#123; System.out.println("Before: invocation=[" + invocation + "]"); Object rval = invocation.proceed(); System.out.println("Invocation returned"); return rval; &#125; &#125; Before advice 1234567891011public class CountingBeforeAdvice implements MethodBeforeAdvice &#123; private int count; public void before(Method m, Object[] args, Object target) throws Throwable &#123; ++count; &#125; public int getCount() &#123; return count; &#125; &#125; Throws advice 123456789101112public static class CombinedThrowsAdvice implements ThrowsAdvice &#123; public void afterThrowing( RemoteException ex) throws Throwable &#123; // Do something with remote exception &#125; public void afterThrowing( Method m, Object[] args, Object target, ServletException ex&#123; // Do something with all arguments &#125;&#125; After Returning advice 12345678910111213 public class CountingAfterReturningAdvice implements AfterReturningAdvice &#123; private int count; public void afterReturning( Object returnValue, Method m, Object[] args, Object target) throws Throwable &#123; ++count; &#125; public int getCount() &#123; return count; &#125;&#125; Introduction advice 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950/** * å¼•å…¥æŽ¥å£å®šä¹‰ */public interface Lockable &#123; void lock(); void unlock(); boolean locked(); &#125;/** * IntroductionIntecptor å®šä¹‰ * IntroductionIntecptor éœ€è¦å®žçŽ°è¢«å¼•å…¥çš„æŽ¥å£ * invoke æ–¹æ³•å®šä¹‰äº†æ‹¦æˆªé€»è¾‘ï¼ˆè¦†å†™å¯é€‰ï¼‰ */ public class LockMixin extends DelegatingIntroductionInterceptor implements Lockable &#123; private boolean locked; public void lock() &#123; this.locked = true; &#125; public void unlock() &#123; this.locked = false; &#125; public boolean locked() &#123; return this.locked; &#125; public Object invoke(MethodInvocation invocation) throws Throwable &#123; if (locked() &amp;&amp; invocation.getMethod().getName().indexOf("set") == 0) &#123; throw new LockedException(); &#125; return super.invoke(invocation); &#125; &#125;/** * IntroductionAdvisor å®šä¹‰ * IntroductionAdvisor å®šä¹‰äº† å¼•å…¥æŽ¥å£ å’Œ é»˜è®¤IntroductionIntecptorå®žä¾‹ç±» */public class LockMixinAdvisor extends DefaultIntroductionAdvisor &#123; public LockMixinAdvisor() &#123; super(new LockMixin(), Lockable.class); &#125;&#125; 3. Advisor APIspring ä¸­ï¼Œadvisor æ˜¯åŒ…å«äº† advice å’Œ pointcut çš„åˆ‡é¢ç»„åˆã€‚é™¤äº†ç‰¹æ®Šçš„ Introduction adviceï¼ˆå¼•å…¥é€šçŸ¥ï¼‰ï¼Œä»»ä½•advisorå¯ä»¥ä½¿ç”¨ä»»ä½•adviceã€‚DefaultPointcutAdvisor æ˜¯ä½¿ç”¨æœ€é¢‘ç¹çš„ advisorã€‚]]></content>
    </entry>

    
  
  
</search>
